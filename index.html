<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Bleu 班表系統 - 現代化的排班解決方案">
    <meta name="author" content="DK0124">
    <title>Bleu 班表系統 - 管理後台</title>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23003D52' d='M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z'/></svg>">
    
    <style>
        /* Bleu 班表系統 色系 */
        :root {
            --bleu-primary: #003D52;
            --bleu-secondary: #83968B;
            --bleu-accent: #EE7836;
            --bleu-light: #BCDBE4;
            --bleu-white: #FFFFFF;
            --bleu-bg: #F8FAFC;
            --bleu-gray-light: #EFF6F9;
            --bleu-gray: #DDE4E7;
            --bleu-gray-dark: #6B7C74;
            --bleu-text: #2C3E50;
            --bleu-shadow: 0 4px 15px rgba(0, 61, 82, 0.07);
            --bleu-shadow-hover: 0 6px 25px rgba(0, 61, 82, 0.1);
            --bleu-radius: 12px;
            --bleu-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            
            /* 圖示大小變數 */
            --avatar-size-small: 20px;
            --avatar-size-normal: 24px;
            --avatar-size-large: 28px;
            --avatar-size-xlarge: 32px;
            --avatar-current-size: var(--avatar-size-normal);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        html { 
            scroll-behavior: smooth; 
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bleu-bg);
            color: var(--bleu-text);
            line-height: 1.6;
            overscroll-behavior: none;
        }

        .material-icons, 
        .material-icons-outlined { 
            vertical-align: middle; 
            font-size: 20px; 
        }
        
        .btn .material-icons, 
        .btn .material-icons-outlined { 
            margin-right: 6px; 
        }

        .app { 
            padding: 25px; 
        }

        /* 即時同步狀態指示器 */
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bleu-white);
            border-radius: 20px;
            box-shadow: var(--bleu-shadow);
            z-index: 999;
            transition: var(--bleu-transition);
        }

        .sync-indicator.syncing {
            background: #FFF9C4;
        }

        .sync-indicator.error {
            background: #FFEBEE;
        }

        .sync-indicator.success {
            background: #E8F5E9;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        .sync-indicator.error .sync-dot {
            background: #F44336;
            animation: none;
        }

        .sync-indicator.syncing .sync-dot {
            background: #FF9800;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .sync-text {
            font-size: 12px;
            color: var(--bleu-gray-dark);
            font-weight: 500;
        }

        .page-title { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        
        .page-title h1 { 
            font-size: 28px; 
            font-weight: 700; 
            color: var(--bleu-primary); 
        }
        
        .page-title .material-icons { 
            font-size: 32px; 
            color: var(--bleu-primary); 
        }

        .btn {
            padding: 8px 18px; 
            border: none; 
            border-radius: 8px; 
            font-size: 14px;
            font-weight: 600; 
            cursor: pointer; 
            transition: var(--bleu-transition);
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            white-space: nowrap;
        }
        
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }
        
        .btn-primary { 
            background: var(--bleu-primary); 
            color: white; 
        }
        
        .btn-primary:hover:not(:disabled) { 
            background: #002A3A; 
            transform: translateY(-2px); 
            box-shadow: var(--bleu-shadow-hover); 
        }
        
        .btn-accent { 
            background: var(--bleu-accent); 
            color: white; 
        }
        
        .btn-accent:hover:not(:disabled) { 
            background: #D66327; 
            transform: translateY(-2px); 
            box-shadow: var(--bleu-shadow-hover); 
        }
        
        .btn-secondary {
            background: var(--bleu-secondary);
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #6B7C74;
        }
        
        .btn-success {
            background: #28A745;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #218838;
        }
        
        .btn-info {
            background: #17A2B8;
            color: white;
        }
        
        .btn-info:hover:not(:disabled) {
            background: #138496;
        }
        
        .btn-icon { 
            padding: 8px; 
            border-radius: 50%; 
            background: transparent; 
            color: var(--bleu-primary); 
        }
        
        .btn-icon:hover { 
            background: var(--bleu-light); 
        }
        
        .btn-icon .material-icons { 
            margin: 0; 
        }

        .calendar-container {
            background: var(--bleu-white); 
            border-radius: var(--bleu-radius);
            padding: 25px; 
            box-shadow: var(--bleu-shadow);
        }
        
        .calendar-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 25px; 
            padding-bottom: 15px; 
            border-bottom: 2px solid var(--bleu-gray-light);
        }
        
        .calendar-nav { 
            display: flex; 
            align-items: center; 
            gap: 20px; 
        }
        
        .calendar-title { 
            font-size: 22px; 
            font-weight: 600; 
            color: var(--bleu-primary); 
        }
        
        .calendar-actions { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }

        .calendar-grid {
            display: grid; 
            grid-template-columns: repeat(7, 1fr);
            border-top: 1px solid var(--bleu-gray); 
            border-left: 1px solid var(--bleu-gray);
        }
        
        .calendar-cell {
            border-right: 1px solid var(--bleu-gray); 
            border-bottom: 1px solid var(--bleu-gray);
            min-height: 120px; 
            padding: 8px; 
            display: flex; 
            flex-direction: column;
            transition: var(--bleu-transition); 
            position: relative;
        }
        
        .weekday-header {
            text-align: center; 
            font-weight: 600; 
            font-size: 13px;
            color: var(--bleu-secondary); 
            padding: 10px 0;
        }
        
        .date-cell { 
            cursor: pointer; 
        }
        
        .date-cell:hover { 
            background: var(--bleu-gray-light); 
        }
        
        .date-number { 
            font-weight: 600; 
            color: var(--bleu-text); 
            margin-bottom: 8px; 
            text-align: right; 
        }
        
        .date-cell.today .date-number {
            background: var(--bleu-primary); 
            color: white; 
            border-radius: 50%;
            width: 24px; 
            height: 24px; 
            display: flex; 
            align-items: center;
            justify-content: center; 
            margin-left: auto;
        }
        
        .date-cell.other-month { 
            opacity: 0.4; 
            background-color: #F8F9FA; 
            pointer-events: none; 
        }
        
        .daily-schedules { 
            display: flex; 
            flex-direction: column;
            gap: 4px;
            width: 100%;
        }
        
        .schedule-time-group {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .time-label {
            font-size: 10px;
            color: var(--bleu-gray-dark);
            min-width: 35px;
            font-weight: 600;
        }
        
        .employee-avatar-badge {
            width: var(--avatar-current-size);
            height: var(--avatar-current-size);
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: calc(var(--avatar-current-size) * 0.45);
            font-weight: 600; 
            color: white;
            transition: var(--bleu-transition); 
            border: 2px solid var(--bleu-white);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            flex-shrink: 0;
        }
        
        .employee-avatar-badge:hover {
            transform: scale(1.1);
            z-index: 10;
        }

        .floating-panel {
            position: fixed; 
            top: 25px; 
            right: 25px; 
            width: 340px; 
            background: var(--bleu-white);
            border-radius: var(--bleu-radius); 
            box-shadow: var(--bleu-shadow-hover);
            z-index: 1000; 
            display: flex; 
            flex-direction: column;
            max-height: calc(100vh - 50px); 
            transform: translateX(120%); 
            opacity: 0;
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
        }
        
        .floating-panel.open { 
            transform: translateX(0); 
            opacity: 1; 
        }
        
        .panel-header {
            padding: 15px 20px; 
            border-bottom: 2px solid var(--bleu-gray-light);
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: grab;
        }
        
        .panel-title {
            color: var(--bleu-primary); 
            font-size: 18px; 
            font-weight: 600;
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        
        .panel-content { 
            padding: 20px; 
            overflow-y: auto; 
            flex: 1; 
        }
        
        .panel-section { 
            margin-bottom: 25px; 
        }
        
        .panel-section h3 {
            color: var(--bleu-primary); 
            font-size: 16px; 
            margin-bottom: 15px;
            display: flex; 
            align-items: center; 
            gap: 8px;
        }

        .sync-status {
            font-size: 12px;
            color: var(--bleu-gray-dark);
            margin-top: 10px;
            padding: 10px;
            background: var(--bleu-gray-light);
            border-radius: 6px;
        }

        .sync-status.connected {
            color: #28A745;
            background: #E8F5E9;
        }
        
        .sync-status-item {
            display: flex;
            justify-content: space-between;
            margin: 4px 0;
        }

        .url-input-group {
            margin-bottom: 10px;
            padding: 10px;
            background: var(--bleu-gray-light);
            border-radius: 8px;
        }

        .url-input-group label {
            display: block;
            font-size: 12px;
            color: var(--bleu-primary);
            margin-bottom: 5px;
            font-weight: 600;
        }

        .url-input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--bleu-gray);
            border-radius: 4px;
            font-size: 12px;
            font-family: monospace;
        }

        .url-input-group .btn {
            margin-top: 8px;
            font-size: 12px;
            padding: 6px 12px;
        }
        
        .realtime-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px;
            background: var(--bleu-light);
            border-radius: 8px;
            margin-top: 10px;
        }

        .realtime-toggle label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            font-weight: 600;
            color: var(--bleu-primary);
        }

        .toggle-switch {
            position: relative;
            width: 48px;
            height: 24px;
            background: var(--bleu-gray);
            border-radius: 12px;
            cursor: pointer;
            transition: var(--bleu-transition);
        }

        .toggle-switch.active {
            background: var(--bleu-accent);
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: var(--bleu-transition);
        }

        .toggle-switch.active::after {
            transform: translateX(24px);
        }
        
        .size-controller {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bleu-gray-light);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .size-controller label {
            font-size: 12px;
            color: var(--bleu-primary);
            font-weight: 600;
            min-width: 80px;
        }

        .size-slider {
            flex: 1;
            -webkit-appearance: none;
            appearance: none;
            height: 6px;
            border-radius: 3px;
            background: var(--bleu-gray);
            outline: none;
        }

        .size-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--bleu-primary);
            cursor: pointer;
        }

        .size-slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--bleu-primary);
            cursor: pointer;
        }

        .size-display {
            min-width: 45px;
            text-align: center;
            font-size: 12px;
            color: var(--bleu-secondary);
            font-weight: 600;
        }

        .item-list { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        
        .list-item {
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 12px;
            background: var(--bleu-gray-light); 
            border-radius: 8px; 
            transition: var(--bleu-transition);
        }
        
        .list-item:hover { 
            background: var(--bleu-light); 
        }
        
        .item-details { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        
        .avatar-initial {
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            color: white;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 600;
        }
        
        .text-primary { 
            color: var(--bleu-primary); 
            font-weight: 600; 
        }
        
        .text-secondary { 
            color: var(--bleu-gray-dark); 
            font-size: 13px; 
        }

        .modal {
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            background: rgba(0, 61, 82, 0.7); 
            backdrop-filter: blur(10px); 
            z-index: 1010; 
            padding: 20px;
        }
        
        .modal.show { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        .modal-content {
            background: var(--bleu-white); 
            border-radius: var(--bleu-radius);
            max-width: 600px; 
            width: 100%; 
            max-height: 90vh; 
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 61, 82, 0.2);
        }
        
        .modal-header { 
            padding: 20px; 
            border-bottom: 2px solid var(--bleu-gray-light); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .modal-body { 
            padding: 25px; 
        }
        
        .modal-footer { 
            padding: 20px; 
            background: var(--bleu-gray-light); 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: var(--bleu-primary); 
            font-size: 14px; 
        }
        
        .form-control { 
            width: 100%; 
            padding: 10px 12px; 
            border: 2px solid var(--bleu-gray); 
            border-radius: 6px; 
            font-size: 14px; 
            transition: var(--bleu-transition); 
        }
        
        .form-control:focus { 
            outline: none; 
            border-color: var(--bleu-primary); 
        }

        .time-group {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 10px;
        }

        .time-separator {
            color: var(--bleu-secondary);
            font-weight: 600;
        }

        .employee-select-list {
            border: 2px solid var(--bleu-gray);
            border-radius: 8px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            background: var(--bleu-gray-light);
        }

        .employee-checkbox {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: var(--bleu-white);
            border-radius: 6px;
            cursor: pointer;
            transition: var(--bleu-transition);
        }

        .employee-checkbox:hover {
            background: var(--bleu-light);
        }

        .employee-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            accent-color: var(--bleu-primary);
        }

        .employee-checkbox label {
            flex: 1;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scheduled-list {
            margin-top: 20px;
            padding: 15px;
            background: var(--bleu-gray-light);
            border-radius: 8px;
            border: 2px solid var(--bleu-light);
        }

        .scheduled-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bleu-white);
            border-radius: 6px;
            transition: var(--bleu-transition);
        }

        .scheduled-item:hover {
            box-shadow: var(--bleu-shadow);
        }

        .quick-settings {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .preset-shift {
            padding: 10px;
            text-align: center;
            background: var(--bleu-gray-light);
            border: 2px solid var(--bleu-gray);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: var(--bleu-transition);
            color: var(--bleu-gray-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .preset-shift:hover {
            background: var(--bleu-light);
            border-color: var(--bleu-primary);
            color: var(--bleu-primary);
        }

        .preset-shift.active {
            background: var(--bleu-primary);
            border-color: var(--bleu-primary);
            color: white;
        }

        .toast {
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%) translateY(100px);
            background: var(--bleu-primary); 
            color: white; 
            padding: 14px 24px; 
            border-radius: 8px;
            opacity: 0; 
            transition: var(--bleu-transition); 
            z-index: 2000;
            box-shadow: 0 4px 20px rgba(0, 61, 82, 0.3); 
            font-weight: 500;
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        
        .toast.show { 
            opacity: 1; 
            transform: translateX(-50%) translateY(0); 
        }

        .toast.error {
            background: #DC3545;
        }

        .toast.success {
            background: #28A745;
        }
        
        .toast.warning {
            background: #FFC107;
            color: #333;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--bleu-gray);
            border-top-color: var(--bleu-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* RWD 響應式設計 */
        @media (max-width: 768px) {
            .app { 
                padding: 10px; 
            }
            
            .sync-indicator {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
            }
            
            .page-title {
                gap: 10px;
                margin-bottom: 15px;
            }
            
            .page-title h1 { 
                font-size: 20px; 
            }
            
            .page-title .material-icons { 
                font-size: 24px; 
            }
            
            .calendar-container { 
                padding: 10px; 
                border-radius: 8px;
            }
            
            .calendar-header {
                flex-direction: column;
                gap: 10px;
                margin-bottom: 15px;
                padding-bottom: 10px;
            }
            
            .calendar-nav {
                width: 100%;
                justify-content: center;
            }
            
            .calendar-actions {
                width: 100%;
                justify-content: center;
                flex-wrap: wrap;
            }
            
            .calendar-title { 
                font-size: 18px; 
            }
            
            .calendar-cell { 
                min-height: 70px;
                padding: 4px;
            }
            
            .date-number {
                font-size: 12px;
                margin-bottom: 4px;
            }
            
            .weekday-header {
                font-size: 11px;
                padding: 8px 0;
            }
            
            .time-label {
                display: none;
            }
            
            .schedule-time-group {
                gap: 2px;
                margin-bottom: 2px;
            }
            
            :root {
                --avatar-current-size: var(--avatar-size-small);
            }
            
            .btn { 
                padding: 6px 10px; 
                font-size: 12px; 
            }
            
            .btn .material-icons,
            .btn .material-icons-outlined {
                font-size: 16px;
                margin-right: 4px;
            }
            
            .floating-panel { 
                width: calc(100% - 20px); 
                top: 10px; 
                right: 10px;
                left: 10px;
                max-height: 85vh; 
            }
            
            .panel-content {
                padding: 15px;
            }
            
            .panel-section {
                margin-bottom: 20px;
            }
            
            .panel-section h3 {
                font-size: 14px;
                margin-bottom: 10px;
            }
            
            .modal {
                padding: 10px;
            }
            
            .modal-content {
                max-width: 100%;
                max-height: 95vh;
            }
            
            .modal-header {
                padding: 15px;
            }
            
            .modal-body {
                padding: 15px;
            }
            
            .modal-footer {
                padding: 15px;
                flex-wrap: wrap;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-label {
                font-size: 12px;
                margin-bottom: 6px;
            }
            
            .form-control {
                padding: 8px 10px;
                font-size: 13px;
            }
            
            .quick-settings {
                grid-template-columns: repeat(2, 1fr);
                gap: 6px;
            }
            
            .preset-shift {
                padding: 8px;
                font-size: 11px;
            }
            
            .employee-select-list {
                max-height: 150px;
                padding: 6px;
            }
            
            .employee-checkbox {
                padding: 8px;
                margin-bottom: 4px;
            }
            
            .employee-checkbox label {
                font-size: 13px;
            }
            
            .scheduled-list {
                margin-top: 15px;
                padding: 10px;
            }
            
            .scheduled-item {
                padding: 8px;
                margin-bottom: 6px;
                font-size: 12px;
            }
            
            .toast {
                bottom: 10px;
                padding: 10px 16px;
                font-size: 13px;
                max-width: calc(100% - 40px);
            }
            
            .list-item {
                padding: 10px;
            }
            
            .avatar-initial {
                width: 30px;
                height: 30px;
                font-size: 14px;
            }
            
            .text-primary {
                font-size: 13px;
            }
            
            .text-secondary {
                font-size: 11px;
            }
        }

        /* 小手機優化 */
        @media (max-width: 374px) {
            .calendar-cell {
                min-height: 60px;
                padding: 2px;
            }
            
            .date-number {
                font-size: 11px;
            }
            
            .weekday-header {
                font-size: 10px;
            }
            
            :root {
                --avatar-current-size: 18px;
            }
            
            .page-title h1 {
                font-size: 18px;
            }
            
            .btn {
                padding: 5px 8px;
                font-size: 11px;
            }
        }

        /* 平板優化 */
        @media (min-width: 768px) and (max-width: 1024px) {
            .calendar-cell {
                min-height: 100px;
            }
            
            .floating-panel {
                width: 380px;
            }
        }
    </style>
</head>

<body>
    <!-- 即時同步狀態指示器 -->
    <div class="sync-indicator" id="syncIndicator">
        <div class="sync-dot"></div>
        <span class="sync-text">即時同步已啟用</span>
    </div>

    <div class="app">
        <div class="page-title">
            <span class="material-icons">event_note</span>
            <h1>Bleu 班表系統 - 管理後台</h1>
        </div>
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="btn btn-icon" onclick="App.previousMonth()">
                        <span class="material-icons">chevron_left</span>
                    </button>
                    <h2 class="calendar-title" id="currentMonth"></h2>
                    <button class="btn btn-icon" onclick="App.nextMonth()">
                        <span class="material-icons">chevron_right</span>
                    </button>
                </div>
                <div class="calendar-actions">
                    <button class="btn btn-primary" onclick="App.togglePanel()">
                        <span class="material-icons-outlined">menu</span>
                        管理面板
                    </button>
                    <button class="btn btn-secondary" onclick="App.exportCSV()">
                        <span class="material-icons-outlined">download</span>
                        匯出 CSV
                    </button>
                    <a href="employee-view.html" class="btn btn-info" style="text-decoration: none;">
                        <span class="material-icons-outlined">visibility</span>
                        員工檢視
                    </a>
                </div>
            </div>
            <div id="calendarHeader" class="calendar-grid"></div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <div class="floating-panel" id="floatingPanel">
        <div class="panel-header" id="panelHeader">
            <h2 class="panel-title">
                <span class="material-icons">admin_panel_settings</span>
                管理面板
            </h2>
            <button class="btn btn-icon" onclick="App.togglePanel()">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="panel-content">
            <!-- Google Sheets 同步區塊 -->
            <div class="panel-section">
                <h3><span class="material-icons-outlined">cloud_sync</span>Google Sheets 即時同步</h3>
                
                <div class="url-input-group">
                    <label for="scriptUrlInput">Apps Script 網址：</label>
                    <input type="text" id="scriptUrlInput" placeholder="輸入您的 Script URL..." />
                    <button class="btn btn-success" onclick="App.saveScriptUrl()">
                        <span class="material-icons">save</span>
                        儲存網址
                    </button>
                    <button class="btn btn-secondary" onclick="App.testConnection()" style="margin-left: 5px;">
                        <span class="material-icons">wifi</span>
                        測試連線
                    </button>
                </div>
                
                <!-- 即時同步開關 -->
                <div class="realtime-toggle">
                    <label>
                        <span class="material-icons">sync</span>
                        即時同步模式
                    </label>
                    <div class="toggle-switch" id="realtimeToggle" onclick="App.toggleRealtimeMode()">
                    </div>
                </div>
                
                <div class="sync-status" id="syncStatus">
                    <div class="sync-status-item">
                        <span>連線狀態：</span>
                        <span id="syncStatusText">未連線</span>
                    </div>
                    <div class="sync-status-item">
                        <span>最後同步：</span>
                        <span id="lastSyncTime">無</span>
                    </div>
                    <div class="sync-status-item">
                        <span>自動同步：</span>
                        <span id="autoSyncStatus">已停用</span>
                    </div>
                </div>
            </div>
            
            <!-- 顯示設定區塊 -->
            <div class="panel-section">
                <h3><span class="material-icons-outlined">photo_size_select_large</span>顯示設定</h3>
                
                <div class="size-controller">
                    <label for="avatarSizeSlider">圖示大小：</label>
                    <input type="range" id="avatarSizeSlider" class="size-slider" 
                           min="18" max="32" value="24" step="2"
                           oninput="App.updateAvatarSize(this.value)">
                    <span class="size-display" id="sizeDisplay">24px</span>
                </div>
                
                <div style="margin-top: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; font-size: 13px;">
                        <input type="checkbox" id="autoSizeMobile" checked 
                               onchange="App.toggleAutoSizeMobile(this.checked)">
                        <span>手機自動調整大小</span>
                    </label>
                </div>
            </div>
            
            <!-- 班次管理區塊 -->
            <div class="panel-section">
                <h3><span class="material-icons-outlined">schedule</span>班次時段管理</h3>
                <div class="item-list" id="shiftList"></div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="App.openShiftModal()">
                    <span class="material-icons">add</span>
                    新增時段
                </button>
            </div>
            
            <!-- 員工管理區塊 -->
            <div class="panel-section">
                <h3><span class="material-icons-outlined">badge</span>員工管理</h3>
                <div class="item-list" id="employeeList"></div>
                <button class="btn btn-accent" style="width: 100%; margin-top: 15px;" onclick="App.openEmployeeModal()">
                    <span class="material-icons">person_add</span>
                    新增員工
                </button>
            </div>
        </div>
    </div>

    <!-- 員工模態框 -->
    <div class="modal" id="employeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>員工資料</h3>
                <button class="btn btn-icon" onclick="App.closeModal('employeeModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="employeeForm">
                    <div class="form-group">
                        <label class="form-label">姓名 *</label>
                        <input type="text" class="form-control" id="employeeName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">頭像文字 (1-2字)</label>
                        <input type="text" class="form-control" id="employeeAvatarText" maxlength="2" placeholder="例：明、A1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">類型</label>
                        <select class="form-control" id="employeeType">
                            <option value="fulltime">正職</option>
                            <option value="parttime">兼職</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">電話</label>
                        <input type="tel" class="form-control" id="employeePhone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="employeeEmail">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.closeModal('employeeModal')">取消</button>
                <button class="btn btn-accent" onclick="App.deleteEmployee()" id="deleteEmployeeBtn" style="display: none;">刪除</button>
                <button class="btn btn-primary" onclick="App.saveEmployee()">儲存</button>
            </div>
        </div>
    </div>

    <!-- 排班模態框 -->
    <div class="modal" id="scheduleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="scheduleTitle">排班設定</h3>
                <button class="btn btn-icon" onclick="App.closeModal('scheduleModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    <div class="form-group">
                        <label class="form-label">快速選擇班次</label>
                        <div class="quick-settings" id="quickShifts"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">自訂時間</label>
                        <div class="time-group">
                            <input type="time" class="form-control" id="startTime">
                            <span class="time-separator">至</span>
                            <input type="time" class="form-control" id="endTime">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">選擇員工（可多選）</label>
                        <div class="employee-select-list" id="employeeSelectList"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">備註</label>
                        <textarea class="form-control" id="scheduleNotes" rows="2" placeholder="輸入備註..."></textarea>
                    </div>
                    <div class="scheduled-list">
                        <h4 style="margin-bottom: 10px; color: var(--bleu-primary);">當日已排班</h4>
                        <div id="currentSchedules"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-accent" onclick="App.clearDaySchedule()">清空當日</button>
                <button class="btn" onclick="App.closeModal('scheduleModal')">取消</button>
                <button class="btn btn-primary" onclick="App.saveSchedule()">儲存排班</button>
            </div>
        </div>
    </div>

    <!-- 時段管理模態框 -->
    <div class="modal" id="shiftModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="shiftModalTitle">新增自訂時段</h3>
                <button class="btn btn-icon" onclick="App.closeModal('shiftModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="shiftForm">
                    <div class="form-group">
                        <label class="form-label">時段名稱 *</label>
                        <input type="text" class="form-control" id="shiftName" placeholder="例如：大夜班">
                    </div>
                    <div class="form-group">
                        <label class="form-label">時間範圍</label>
                        <div class="time-group">
                            <input type="time" class="form-control" id="shiftStartTime">
                            <span class="time-separator">至</span>
                            <input type="time" class="form-control" id="shiftEndTime">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-accent" onclick="App.deleteEditingShift()" id="deleteShiftBtn" style="display: none;">刪除時段</button>
                <button class="btn" onclick="App.closeModal('shiftModal')">取消</button>
                <button class="btn btn-primary" onclick="App.saveShift()">儲存時段</button>
            </div>
        </div>
    </div>

    <!-- 通知 -->
    <div class="toast" id="toast"></div>

    <script>
        const App = {
            // 資料屬性
            employees: [],
            schedules: {},
            shifts: [],
            currentMonth: new Date(),
            editingEmployee: null,
            editingShiftId: null,
            currentDate: null,
            scriptUrl: '',
            
            // 即時同步相關
            realTimeMode: false,
            autoSyncInterval: null,
            lastDataHash: null,
            isSyncing: false,
            syncFailCount: 0,
            
            // 同步狀態
            isConnected: false,
            lastSyncTime: null,
            toastTimeout: null,
            
            // 顯示設定
            avatarSize: 24,
            autoSizeMobile: true,
            isMobile: false,
            
            // 快取管理
            cacheVersion: '2.0.0',

            async init() {
                this.checkMobile();
                this.loadScriptUrl();
                this.loadSizeSettings();
                
                // 如果有 Script URL，先從雲端載入資料
                if (this.scriptUrl) {
                    await this.loadFromCloud();
                } else {
                    // 否則載入本地資料
                    this.loadLocalData();
                }
                
                this.renderAll();
                this.setupPanelDrag();
                this.loadSyncStatus();
                
                window.addEventListener('storage', () => this.handleStorageChange());
                window.addEventListener('resize', () => this.handleResize());
                
                // 自動啟用即時同步（如果有設定 URL）
                if (this.scriptUrl) {
                    this.enableRealTimeMode();
                }
            },

            // === 即時同步功能 ===
            enableRealTimeMode() {
                if (!this.scriptUrl) {
                    this.showToast('請先設定 Script URL', 'error');
                    return;
                }
                
                this.realTimeMode = true;
                
                // 更新 UI
                const toggle = document.getElementById('realtimeToggle');
                toggle.classList.add('active');
                document.getElementById('autoSyncStatus').textContent = '已啟用';
                
                // 啟動自動同步（每5秒）
                this.startAutoSync();
                
                // 立即同步一次
                this.syncWithSheets();
                
                this.showToast('即時同步已啟用', 'success');
            },

            disableRealTimeMode() {
                this.realTimeMode = false;
                
                // 更新 UI
                const toggle = document.getElementById('realtimeToggle');
                toggle.classList.remove('active');
                document.getElementById('autoSyncStatus').textContent = '已停用';
                
                // 停止自動同步
                this.stopAutoSync();
                
                this.showToast('即時同步已停用', 'warning');
            },

            toggleRealtimeMode() {
                if (this.realTimeMode) {
                    this.disableRealTimeMode();
                } else {
                    this.enableRealTimeMode();
                }
            },

            startAutoSync() {
                // 清除舊的定時器
                if (this.autoSyncInterval) {
                    clearInterval(this.autoSyncInterval);
                }
                
                // 每5秒同步一次
                this.autoSyncInterval = setInterval(() => {
                    if (this.realTimeMode && !this.isSyncing) {
                        this.syncWithSheets();
                    }
                }, 5000);
            },

            stopAutoSync() {
                if (this.autoSyncInterval) {
                    clearInterval(this.autoSyncInterval);
                    this.autoSyncInterval = null;
                }
            },

            async syncWithSheets() {
                if (!this.scriptUrl || !this.realTimeMode || this.isSyncing) return;
                
                this.isSyncing = true;
                this.updateSyncIndicator('syncing');
                
                try {
                    const response = await fetch(`${this.scriptUrl}?action=getRealtimeData`);
                    
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        // 比對資料是否有變化
                        const dataHash = this.generateDataHash(result.data);
                        
                        if (dataHash !== this.lastDataHash) {
                            // 資料有變化，更新本地
                            this.employees = result.data.employees || [];
                            this.shifts = result.data.shifts || [];
                            this.schedules = result.data.schedules || {};
                            
                            this.lastDataHash = dataHash;
                            
                            // 儲存到本地
                            this.saveLocalData();
                            
                            // 只在背景更新，不干擾用戶操作
                            if (!this.isUserEditing()) {
                                this.renderAll();
                                console.log('資料已自動同步更新');
                            }
                        }
                        
                        // 更新同步狀態
                        this.lastSyncTime = new Date().toISOString();
                        document.getElementById('lastSyncTime').textContent = 
                            new Date(this.lastSyncTime).toLocaleTimeString('zh-TW');
                        
                        this.updateSyncIndicator('success');
                        this.syncFailCount = 0;
                        this.updateSyncStatus(true);
                    }
                } catch (error) {
                    console.error('自動同步失敗:', error);
                    this.syncFailCount++;
                    
                    if (this.syncFailCount >= 3) {
                        // 連續失敗3次，顯示警告
                        this.updateSyncIndicator('error');
                        this.showToast('同步連線中斷，請檢查網路', 'error');
                        
                        // 暫時停用即時同步
                        if (this.syncFailCount >= 5) {
                            this.disableRealTimeMode();
                            this.showToast('即時同步已自動停用', 'error');
                        }
                    }
                } finally {
                    this.isSyncing = false;
                }
            },

            updateSyncIndicator(status) {
                const indicator = document.getElementById('syncIndicator');
                const text = indicator.querySelector('.sync-text');
                
                // 移除所有狀態類別
                indicator.classList.remove('syncing', 'error', 'success');
                
                switch(status) {
                    case 'syncing':
                        indicator.classList.add('syncing');
                        text.textContent = '同步中...';
                        break;
                    case 'error':
                        indicator.classList.add('error');
                        text.textContent = '同步錯誤';
                        break;
                    case 'success':
                    default:
                        indicator.classList.add('success');
                        text.textContent = '即時同步已啟用';
                        break;
                }
            },

            // === 資料載入與儲存 ===
            async loadFromCloud() {
                if (!this.scriptUrl) return;
                
                try {
                    const response = await fetch(`${this.scriptUrl}?action=getRealtimeData`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        this.employees = result.data.employees || [];
                        this.shifts = result.data.shifts || [];
                        this.schedules = result.data.schedules || {};
                        
                        this.lastDataHash = this.generateDataHash(result.data);
                        
                        // 儲存到本地作為快取
                        this.saveLocalData();
                        
                        this.updateSyncStatus(true);
                        console.log('已從雲端載入資料');
                    }
                } catch (error) {
                    console.error('無法從雲端載入，使用本地資料:', error);
                    this.loadLocalData();
                    this.updateSyncStatus(false);
                }
            },

            loadLocalData() {
                const config = localStorage.getItem('bleuConfig');
                const schedules = localStorage.getItem('bleuSchedules');
                
                if (config) {
                    const configData = JSON.parse(config);
                    this.employees = configData.employees || [];
                    this.shifts = configData.shifts || [];
                }
                
                if (schedules) {
                    this.schedules = JSON.parse(schedules);
                }
                
                // 如果沒有資料，初始化預設資料
                if (this.employees.length === 0) {
                    this.initDefaultData();
                }
                
                if (this.shifts.length === 0) {
                    this.initDefaultShifts();
                }
            },

            saveLocalData() {
                const config = {
                    employees: this.employees,
                    shifts: this.shifts,
                    version: this.cacheVersion,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('bleuConfig', JSON.stringify(config));
                localStorage.setItem('bleuSchedules', JSON.stringify(this.schedules));
                
                // 相容舊版本
                const fullData = {
                    employees: this.employees,
                    schedules: this.schedules,
                    shifts: this.shifts,
                    lastUpdated: new Date().toISOString()
                };
                localStorage.setItem('bleuScheduleData', JSON.stringify(fullData));
                localStorage.setItem('lastLocalUpdate', new Date().toISOString());
            },

            initDefaultData() {
                this.employees = [
                    { 
                        id: 1, 
                        name: '王小明', 
                        avatarText: '明',
                        type: 'fulltime', 
                        phone: '0912345678', 
                        email: 'ming@example.com' 
                    },
                    { 
                        id: 2, 
                        name: '李小華', 
                        avatarText: '華',
                        type: 'fulltime', 
                        phone: '0923456789', 
                        email: 'hua@example.com' 
                    },
                    { 
                        id: 3, 
                        name: '張大偉', 
                        avatarText: 'W',
                        type: 'parttime', 
                        phone: '0934567890', 
                        email: 'wei@example.com' 
                    }
                ];
                this.saveLocalData();
            },
            
            initDefaultShifts() {
                if (this.shifts.length === 0) {
                    this.shifts = [
                        { id: 1, name: '早班', startTime: '08:00', endTime: '16:00' },
                        { id: 2, name: '午班', startTime: '16:00', endTime: '00:00' },
                        { id: 3, name: '晚班', startTime: '00:00', endTime: '08:00' }
                    ];
                    this.saveLocalData();
                }
            },

            // === Script URL 管理 ===
            loadScriptUrl() {
                const savedUrl = localStorage.getItem('bleuScriptUrl');
                if (savedUrl) {
                    this.scriptUrl = savedUrl;
                    document.getElementById('scriptUrlInput').value = savedUrl;
                }
            },

            saveScriptUrl() {
                const urlInput = document.getElementById('scriptUrlInput');
                const url = urlInput.value.trim();
                
                if (!url) {
                    this.showToast('請輸入 Script URL', 'error');
                    return;
                }
                
                if (!url.startsWith('https://script.google.com/')) {
                    this.showToast('請輸入有效的 Google Apps Script URL', 'error');
                    return;
                }
                
                this.scriptUrl = url;
                localStorage.setItem('bleuScriptUrl', url);
                this.showToast('Script URL 已儲存', 'success');
                
                // 自動啟用即時同步
                this.enableRealTimeMode();
            },

            async testConnection() {
                if (!this.scriptUrl) {
                    this.showToast('請先設定 Script URL', 'error');
                    return;
                }
                
                try {
                    const response = await fetch(`${this.scriptUrl}?action=getStatus`);
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            this.showToast('Google Sheets 連線正常', 'success');
                            this.updateSyncStatus(true);
                            
                            const status = result.status;
                            this.showToast(
                                `雲端狀態：${status.employeesCount || 0} 位員工，${status.shiftsCount || 0} 個班次，${status.schedulesCount || 0} 筆排班`,
                                'success'
                            );
                            return true;
                        }
                    }
                } catch (error) {
                    this.showToast('無法連接到 Google Sheets', 'error');
                    this.updateSyncStatus(false);
                    return false;
                }
                return false;
            },

            // === 員工管理（即時寫入） ===
			async saveEmployee() {
				const name = document.getElementById('employeeName').value.trim();
				const avatarText = document.getElementById('employeeAvatarText').value.trim();
				
				if (!name) {
					this.showToast('請輸入員工姓名', 'error');
					return;
				}
				
				const employeeData = { 
					name, 
					avatarText: avatarText || name.charAt(0), 
					type: document.getElementById('employeeType').value,
					phone: document.getElementById('employeePhone').value.trim(),
					email: document.getElementById('employeeEmail').value.trim()
				};

				if (this.editingEmployee) {
					employeeData.id = this.editingEmployee.id;
				}

				// 如果啟用即時同步，寫入雲端
				if (this.realTimeMode && this.scriptUrl) {
					try {
						// 使用 GET 請求帶參數（避免 CORS 問題）
						const params = new URLSearchParams();
						params.append('action', 'writeEmployee');
						params.append('data', JSON.stringify(employeeData));
						
						const response = await fetch(`${this.scriptUrl}?${params.toString()}`);
						const result = await response.json();
						
						if (result.success) {
							// 立即更新本地資料
							if (this.editingEmployee) {
								Object.assign(this.editingEmployee, employeeData);
							} else {
								employeeData.id = result.id || Date.now();
								this.employees.push(employeeData);
							}
							
							// 更新畫面
							this.renderAll();
							this.showToast(this.editingEmployee ? '員工資料已更新' : '新員工已新增', 'success');
							
							// 延遲同步完整資料
							setTimeout(() => this.syncWithSheets(), 1000);
						} else {
							throw new Error(result.error || '儲存失敗');
						}
					} catch (error) {
						console.error('儲存員工失敗:', error);
						this.showToast('儲存失敗，請重試', 'error');
						return;
					}
				} else {
					// 本地模式
					if (this.editingEmployee) {
						Object.assign(this.editingEmployee, employeeData);
					} else {
						employeeData.id = Date.now();
						this.employees.push(employeeData);
					}
					this.saveLocalData();
					this.renderAll();
					this.showToast(this.editingEmployee ? '員工資料已更新' : '新員工已新增', 'success');
				}

				this.closeModal('employeeModal');
			},

			async deleteEmployee() {
				if (!this.editingEmployee || !confirm(`確定刪除員工 ${this.editingEmployee.name} 嗎？相關排班也會被移除。`)) return;
				
				const employeeId = this.editingEmployee.id;
				const employeeName = this.editingEmployee.name;
				
				// 如果啟用即時同步，從雲端刪除
				if (this.realTimeMode && this.scriptUrl) {
					try {
						const params = new URLSearchParams();
						params.append('action', 'deleteEmployee');
						params.append('data', JSON.stringify({ id: employeeId }));
						
						const response = await fetch(`${this.scriptUrl}?${params.toString()}`);
						const result = await response.json();
						
						if (result.success) {
							// 立即更新本地資料
							this.employees = this.employees.filter(e => e.id !== employeeId);
							
							// 刪除相關排班
							Object.keys(this.schedules).forEach(date => {
								this.schedules[date] = this.schedules[date].filter(s => s.employeeId !== employeeId);
								if (this.schedules[date].length === 0) delete this.schedules[date];
							});
							
							// 更新畫面
							this.renderAll();
							this.showToast(`員工 ${employeeName} 已刪除`, 'success');
							
							// 延遲同步
							setTimeout(() => this.syncWithSheets(), 1000);
						} else {
							throw new Error(result.error || '刪除失敗');
						}
					} catch (error) {
						console.error('刪除員工失敗:', error);
						this.showToast('刪除失敗，請重試', 'error');
						return;
					}
				} else {
					// 本地模式
					this.employees = this.employees.filter(e => e.id !== employeeId);
					
					Object.keys(this.schedules).forEach(date => {
						this.schedules[date] = this.schedules[date].filter(s => s.employeeId !== employeeId);
						if (this.schedules[date].length === 0) delete this.schedules[date];
					});
					
					this.saveLocalData();
					this.renderAll();
					this.showToast(`員工 ${employeeName} 已刪除`, 'success');
				}
				
				this.closeModal('employeeModal');
			},
            
                // === 班次管理（即時寫入） ===
            async saveShift() {
                const name = document.getElementById('shiftName').value.trim();
                const startTime = document.getElementById('shiftStartTime').value;
                const endTime = document.getElementById('shiftEndTime').value;
                
                if (!name || !startTime || !endTime) {
                    this.showToast('請填寫完整資料', 'error');
                    return;
                }
                
                const shiftData = {
                    name,
                    startTime,
                    endTime
                };
                
                // 如果是編輯模式，加上 ID
                if (this.editingShiftId) {
                    shiftData.id = this.editingShiftId;
                }
                
                // 如果啟用即時同步，寫入雲端
                if (this.realTimeMode && this.scriptUrl) {
                    try {
                        const response = await fetch(`${this.scriptUrl}?action=writeShift`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'text/plain',
                            },
                            mode: 'no-cors',
                            body: JSON.stringify({ data: shiftData })
                        });
                        
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        await this.syncWithSheets();
                        
                        this.showToast(this.editingShiftId ? '時段已更新' : '時段已新增', 'success');
                    } catch (error) {
                        console.error('儲存時段失敗:', error);
                        this.showToast('儲存失敗，請重試', 'error');
                        return;
                    }
                } else {
                    // 本地模式
                    if (this.editingShiftId) {
                        const shift = this.shifts.find(s => s.id === this.editingShiftId);
                        if (shift) {
                            shift.name = name;
                            shift.startTime = startTime;
                            shift.endTime = endTime;
                        }
                    } else {
                        const newShift = {
                            id: Date.now(),
                            name,
                            startTime,
                            endTime
                        };
                        this.shifts.push(newShift);
                    }
                    
                    this.saveLocalData();
                    this.renderShifts();
                    this.showToast(this.editingShiftId ? '時段已更新' : '時段已新增', 'success');
                }
                
                this.editingShiftId = null;
                this.closeModal('shiftModal');
            },

            async deleteShift(id) {
                if (confirm('確定要刪除這個時段嗎？')) {
                    // 如果啟用即時同步，從雲端刪除
                    if (this.realTimeMode && this.scriptUrl) {
                        try {
                            const response = await fetch(`${this.scriptUrl}?action=deleteShift`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'text/plain',
                                },
                                mode: 'no-cors',
                                body: JSON.stringify({ data: { id: id } })
                            });
                            
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            await this.syncWithSheets();
                            
                            this.showToast('時段已刪除', 'success');
                        } catch (error) {
                            console.error('刪除時段失敗:', error);
                            this.showToast('刪除失敗，請重試', 'error');
                        }
                    } else {
                        // 本地模式
                        this.shifts = this.shifts.filter(s => s.id !== id);
                        this.saveLocalData();
                        this.renderShifts();
                        this.showToast('時段已刪除', 'success');
                    }
                }
            },

            async deleteEditingShift() {
                if (this.editingShiftId && confirm('確定要刪除這個時段嗎？')) {
                    await this.deleteShift(this.editingShiftId);
                    this.closeModal('shiftModal');
                    this.editingShiftId = null;
                }
            },

			async saveSchedule() {
				const startTime = document.getElementById('startTime').value;
				const endTime = document.getElementById('endTime').value;
				const notes = document.getElementById('scheduleNotes').value.trim();
				
				const selectedEmployees = [];
				document.querySelectorAll('.employee-checkbox input:checked').forEach(checkbox => {
					selectedEmployees.push(parseInt(checkbox.value));
				});
				
				if (selectedEmployees.length === 0) {
					this.showToast('請選擇至少一位員工', 'error');
					return;
				}
				
				if (!startTime || !endTime) {
					this.showToast('請設定時間', 'error');
					return;
				}
				
				// 先更新本地資料
				if (!this.schedules[this.currentDate]) {
					this.schedules[this.currentDate] = [];
				}
				
				const newSchedules = [];
				selectedEmployees.forEach(employeeId => {
					const hasConflict = this.schedules[this.currentDate].some(s => 
						s.employeeId === employeeId && 
						this.isTimeOverlap(s.startTime, s.endTime, startTime, endTime)
					);
					
					if (!hasConflict) {
						const schedule = {
							employeeId,
							startTime,
							endTime,
							notes
						};
						this.schedules[this.currentDate].push(schedule);
						newSchedules.push({
							date: this.currentDate,
							...schedule
						});
					} else {
						const employee = this.getEmployeeById(employeeId);
						this.showToast(`${employee.name} 在該時段已有排班`, 'error');
					}
				});
				
				// 立即更新畫面
				this.renderCalendar();
				this.loadCurrentSchedules();
				
				// 如果啟用即時同步，寫入雲端
				if (this.realTimeMode && this.scriptUrl && newSchedules.length > 0) {
					try {
						const params = new URLSearchParams();
						params.append('action', 'batchWriteSchedules');
						params.append('data', JSON.stringify(newSchedules));
						
						const response = await fetch(`${this.scriptUrl}?${params.toString()}`);
						const result = await response.json();
						
						if (result.success) {
							this.showToast(`已新增 ${newSchedules.length} 筆排班`, 'success');
							
							// 延遲同步完整資料
							setTimeout(() => this.syncWithSheets(), 1000);
						} else {
							throw new Error(result.error || '儲存失敗');
						}
					} catch (error) {
						console.error('儲存排班失敗:', error);
						// 不要回滾本地更新，避免使用者重複操作
						this.saveLocalData();
					}
				} else {
					// 本地模式
					this.saveLocalData();
					this.showToast('排班已儲存', 'success');
				}
				
				// 清除選擇
				document.querySelectorAll('.employee-checkbox input:checked').forEach(checkbox => {
					checkbox.checked = false;
				});
			},

            async removeSchedule(index) {
                if (this.schedules[this.currentDate]) {
                    const schedule = this.schedules[this.currentDate][index];
                    
                    // 如果啟用即時同步，從雲端刪除
                    if (this.realTimeMode && this.scriptUrl) {
                        try {
                            const response = await fetch(`${this.scriptUrl}?action=deleteSchedule`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'text/plain',
                                },
                                mode: 'no-cors',
                                body: JSON.stringify({ 
                                    data: {
                                        date: this.currentDate,
                                        employeeId: schedule.employeeId,
                                        startTime: schedule.startTime,
                                        endTime: schedule.endTime
                                    }
                                })
                            });
                            
                            await new Promise(resolve => setTimeout(resolve, 1000));
                            await this.syncWithSheets();
                            
                            this.showToast('已移除排班', 'success');
                        } catch (error) {
                            console.error('刪除排班失敗:', error);
                            this.showToast('刪除失敗，請重試', 'error');
                            return;
                        }
                    } else {
                        // 本地模式
                        this.schedules[this.currentDate].splice(index, 1);
                        if (this.schedules[this.currentDate].length === 0) {
                            delete this.schedules[this.currentDate];
                        }
                        this.saveLocalData();
                        this.renderCalendar();
                        this.showToast('已移除排班', 'success');
                    }
                    
                    this.loadCurrentSchedules();
                }
            },

            async clearDaySchedule() {
                if (confirm('確定要清空當日所有排班嗎？')) {
                    // 如果啟用即時同步，需要逐一刪除
                    if (this.realTimeMode && this.scriptUrl && this.schedules[this.currentDate]) {
                        const schedules = [...this.schedules[this.currentDate]];
                        
                        try {
                            for (const schedule of schedules) {
                                await fetch(`${this.scriptUrl}?action=deleteSchedule`, {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'text/plain',
                                    },
                                    mode: 'no-cors',
                                    body: JSON.stringify({ 
                                        data: {
                                            date: this.currentDate,
                                            employeeId: schedule.employeeId,
                                            startTime: schedule.startTime,
                                            endTime: schedule.endTime
                                        }
                                    })
                                });
                            }
                            
                            await new Promise(resolve => setTimeout(resolve, 1500));
                            await this.syncWithSheets();
                            
                            this.showToast('已清空當日排班', 'success');
                        } catch (error) {
                            console.error('清空排班失敗:', error);
                            this.showToast('清空失敗，請重試', 'error');
                            return;
                        }
                    } else {
                        // 本地模式
                        delete this.schedules[this.currentDate];
                        this.saveLocalData();
                        this.renderCalendar();
                        this.showToast('已清空當日排班', 'success');
                    }
                    
                    this.loadCurrentSchedules();
                }
            },

            // === UI 渲染 ===
            renderAll() {
                this.renderCalendar();
                this.renderPanel();
            },

            renderPanel() {
                this.renderEmployees();
                this.renderShifts();
            },

            renderCalendar() {
                const year = this.currentMonth.getFullYear();
                const month = this.currentMonth.getMonth();
                document.getElementById('currentMonth').textContent = `${year}年 ${month + 1}月`;
                
                const calendarGrid = document.getElementById('calendarGrid');
                const calendarHeader = document.getElementById('calendarHeader');
                calendarGrid.innerHTML = '';
                calendarHeader.innerHTML = '';
                
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                calendarHeader.className = 'calendar-grid';
                
                weekdays.forEach(day => {
                    const headerCell = document.createElement('div');
                    headerCell.className = 'weekday-header';
                    headerCell.textContent = day;
                    calendarHeader.appendChild(headerCell);
                });
                
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                for (let i = 0; i < firstDay; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'calendar-cell other-month';
                    calendarGrid.appendChild(cell);
                }
                
                for (let date = 1; date <= daysInMonth; date++) {
                    const cell = this.createDateCell(year, month, date);
                    calendarGrid.appendChild(cell);
                }
                
                const totalCells = firstDay + daysInMonth;
                const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
                
                for (let i = 0; i < remainingCells; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'calendar-cell other-month';
                    calendarGrid.appendChild(cell);
                }
            },

            createDateCell(year, month, date) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell date-cell';
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const today = new Date();
                
                if (year === today.getFullYear() && month === today.getMonth() && date === today.getDate()) {
                    cell.classList.add('today');
                }
                
                const numberDiv = document.createElement('div');
                numberDiv.className = 'date-number';
                numberDiv.textContent = date;
                
                const schedulesDiv = document.createElement('div');
                schedulesDiv.className = 'daily-schedules';
                
                const daySchedules = this.schedules[dateKey] || [];
                
                if (daySchedules.length > 0) {
                    const timeGroups = {};
                    daySchedules.forEach(schedule => {
                        const timeKey = `${schedule.startTime}-${schedule.endTime}`;
                        if (!timeGroups[timeKey]) {
                            timeGroups[timeKey] = [];
                        }
                        timeGroups[timeKey].push(schedule);
                    });
                    
                    const sortedTimes = Object.keys(timeGroups).sort((a, b) => {
                        const aStart = this.timeToMinutes(a.split('-')[0]);
                        const bStart = this.timeToMinutes(b.split('-')[0]);
                        return aStart - bStart;
                    });
                    
                    sortedTimes.forEach(time => {
                        const timeGroup = document.createElement('div');
                        timeGroup.className = 'schedule-time-group';
                        
                        const timeLabel = document.createElement('span');
                        timeLabel.className = 'time-label';
                        timeLabel.textContent = time.split('-')[0];
                        timeGroup.appendChild(timeLabel);
                        
                        timeGroups[time].forEach(schedule => {
                            const employee = this.getEmployeeById(schedule.employeeId);
                            if (employee) {
                                const badge = this.createAvatarBadge(employee, schedule);
                                timeGroup.appendChild(badge);
                            }
                        });
                        
                        schedulesDiv.appendChild(timeGroup);
                    });
                }
                
                cell.appendChild(numberDiv);
                cell.appendChild(schedulesDiv);
                cell.onclick = () => this.openScheduleModal(date);
                return cell;
            },

            createAvatarBadge(employee, schedule) {
                const badge = document.createElement('div');
                badge.className = 'employee-avatar-badge';
                badge.textContent = employee.avatarText || employee.name.charAt(0);
                badge.style.backgroundColor = this.generateColorById(employee.id);
                badge.title = `${employee.name}\n${schedule.startTime}-${schedule.endTime}${schedule.notes ? '\n備註: ' + schedule.notes : ''}`;
                return badge;
            },

            generateColorById(id) {
                const colors = [
                    "#e53935", "#d81b60", "#8e24aa", "#5e35b1", "#3949ab", 
                    "#1e88e5", "#039be5", "#00acc1", "#00897b", "#43a047", 
                    "#7cb342", "#c0ca33", "#fdd835", "#ffb300", "#fb8c00", 
                    "#f4511e", "#6d4c41", "#757575", "#546e7a"
                ];
                return colors[id % colors.length];
            },

            renderEmployees() {
                const list = document.getElementById('employeeList');
                list.innerHTML = '';
                
                if (this.employees.length === 0) { 
                    list.innerHTML = `<div style="text-align: center; color: var(--bleu-gray-dark); padding: 20px;">尚無員工</div>`; 
                    return; 
                }
                
                this.employees.forEach(employee => {
                    const item = document.createElement('div');
                    item.className = 'list-item employee-item';
                    item.innerHTML = `
                        <div class="item-details">
                            <div class="avatar-initial" style="background-color: ${this.generateColorById(employee.id)}">
                                ${employee.avatarText || employee.name.charAt(0)}
                            </div>
                            <div>
                                <div class="text-primary">${employee.name}</div>
                                <div class="text-secondary">${employee.type === 'fulltime' ? '正職' : '兼職'}</div>
                            </div>
                        </div>
                        <button class="btn btn-icon" onclick="event.stopPropagation(); App.openEmployeeModal(${employee.id})">
                            <span class="material-icons">edit</span>
                        </button>`;
                    item.onclick = () => this.openEmployeeModal(employee.id);
                    list.appendChild(item);
                });
            },

            renderShifts() {
                const list = document.getElementById('shiftList');
                list.innerHTML = '';
                
                this.shifts.forEach(shift => {
                    const item = document.createElement('div');
                    item.className = 'list-item shift-item';
                    item.innerHTML = `
                        <div class="item-details">
                            <div>
                                <div class="text-primary">${shift.name}</div>
                                <div class="text-secondary">${shift.startTime} - ${shift.endTime}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <button class="btn btn-icon" onclick="App.editShift(${shift.id})">
                                <span class="material-icons">edit</span>
                            </button>
                            <button class="btn btn-icon" onclick="App.deleteShift(${shift.id})">
                                <span class="material-icons">delete</span>
                            </button>
                        </div>
                    `;
                    list.appendChild(item);
                });
            },

                // === Modal 操作 ===
            openEmployeeModal(employeeId = null) {
                const isNew = employeeId === null;
                this.editingEmployee = isNew ? null : this.getEmployeeById(employeeId);
                const modal = document.getElementById('employeeModal');
                
                modal.querySelector('#employeeName').value = isNew ? '' : this.editingEmployee.name;
                modal.querySelector('#employeeAvatarText').value = isNew ? '' : (this.editingEmployee.avatarText || '');
                modal.querySelector('#employeeType').value = isNew ? 'fulltime' : this.editingEmployee.type;
                modal.querySelector('#employeePhone').value = isNew ? '' : (this.editingEmployee.phone || '');
                modal.querySelector('#employeeEmail').value = isNew ? '' : (this.editingEmployee.email || '');
                modal.querySelector('#deleteEmployeeBtn').style.display = isNew ? 'none' : 'inline-flex';
                modal.classList.add('show');
            },

            openShiftModal() {
                document.getElementById('shiftForm').reset();
                this.editingShiftId = null;
                document.getElementById('shiftModalTitle').textContent = '新增自訂時段';
                document.getElementById('deleteShiftBtn').style.display = 'none';
                document.getElementById('shiftModal').classList.add('show');
            },

            editShift(id) {
                const shift = this.shifts.find(s => s.id === id);
                if (!shift) return;
                
                document.getElementById('shiftName').value = shift.name;
                document.getElementById('shiftStartTime').value = shift.startTime;
                document.getElementById('shiftEndTime').value = shift.endTime;
                
                this.editingShiftId = id;
                document.getElementById('shiftModalTitle').textContent = '編輯時段';
                document.getElementById('deleteShiftBtn').style.display = 'inline-flex';
                document.getElementById('shiftModal').classList.add('show');
            },

            openScheduleModal(date) {
                const year = this.currentMonth.getFullYear();
                const month = this.currentMonth.getMonth();
                this.currentDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                
                document.getElementById('scheduleTitle').textContent = `${year}年${month + 1}月${date}日 排班設定`;
                
                const quickShifts = document.getElementById('quickShifts');
                quickShifts.innerHTML = '';
                this.shifts.forEach(shift => {
                    const btn = document.createElement('div');
                    btn.className = 'preset-shift';
                    btn.textContent = shift.name;
                    btn.onclick = () => {
                        document.querySelectorAll('.preset-shift').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        document.getElementById('startTime').value = shift.startTime;
                        document.getElementById('endTime').value = shift.endTime;
                    };
                    quickShifts.appendChild(btn);
                });
                
                const employeeSelectList = document.getElementById('employeeSelectList');
                employeeSelectList.innerHTML = '';
                
                this.employees.forEach(emp => {
                    const div = document.createElement('div');
                    div.className = 'employee-checkbox';
                    div.innerHTML = `
                        <input type="checkbox" id="emp_${emp.id}" value="${emp.id}">
                        <label for="emp_${emp.id}">
                            <span>${emp.name}</span>
                            <span style="font-size: 12px; color: var(--bleu-secondary);">
                                ${emp.type === 'fulltime' ? '正職' : 'PT'}
                            </span>
                        </label>
                    `;
                    employeeSelectList.appendChild(div);
                });
                
                this.loadCurrentSchedules();
                
                document.getElementById('startTime').value = '';
                document.getElementById('endTime').value = '';
                document.getElementById('scheduleNotes').value = '';
                
                document.getElementById('scheduleModal').classList.add('show');
            },

            loadCurrentSchedules() {
                const currentSchedules = document.getElementById('currentSchedules');
                currentSchedules.innerHTML = '';
                
                const schedules = this.schedules[this.currentDate] || [];
                
                if (schedules.length === 0) {
                    currentSchedules.innerHTML = '<div style="text-align: center; color: var(--bleu-gray-dark);">尚無排班</div>';
                    return;
                }
                
                const sortedSchedules = [...schedules].sort((a, b) => {
                    return this.timeToMinutes(a.startTime) - this.timeToMinutes(b.startTime);
                });
                
                sortedSchedules.forEach((schedule, index) => {
                    const div = document.createElement('div');
                    div.className = 'scheduled-item';
                    div.innerHTML = `
                        <div class="scheduled-info">
                            <span class="scheduled-name">${this.getEmployeeName(schedule.employeeId)}</span>
                            <span class="scheduled-time">${schedule.startTime} - ${schedule.endTime}</span>
                        </div>
                        <button class="btn btn-icon" onclick="App.removeSchedule(${schedules.indexOf(schedule)})">
                            <span class="material-icons">remove</span>
                        </button>
                    `;
                    currentSchedules.appendChild(div);
                });
            },

            closeModal(id) { 
                document.getElementById(id).classList.remove('show'); 
            },

            // === 顯示設定管理 ===
            checkMobile() {
                this.isMobile = window.innerWidth <= 768;
                
                if (this.isMobile && this.autoSizeMobile) {
                    this.applyMobileSize();
                }
            },
            
            handleResize() {
                const wasMobile = this.isMobile;
                this.checkMobile();
                
                if (wasMobile !== this.isMobile) {
                    if (this.isMobile && this.autoSizeMobile) {
                        this.applyMobileSize();
                    } else if (!this.isMobile) {
                        this.restoreDesktopSize();
                    }
                }
            },
            
            applyMobileSize() {
                const mobileSize = window.innerWidth <= 374 ? 18 : 20;
                document.documentElement.style.setProperty('--avatar-current-size', `${mobileSize}px`);
            },
            
            restoreDesktopSize() {
                document.documentElement.style.setProperty('--avatar-current-size', `${this.avatarSize}px`);
                const slider = document.getElementById('avatarSizeSlider');
                if (slider) {
                    slider.value = this.avatarSize;
                    document.getElementById('sizeDisplay').textContent = `${this.avatarSize}px`;
                }
            },
            
            updateAvatarSize(size) {
                this.avatarSize = parseInt(size);
                
                if (!this.isMobile || !this.autoSizeMobile) {
                    document.documentElement.style.setProperty('--avatar-current-size', `${size}px`);
                }
                
                document.getElementById('sizeDisplay').textContent = `${size}px`;
                localStorage.setItem('avatarSize', size);
            },
            
            toggleAutoSizeMobile(enabled) {
                this.autoSizeMobile = enabled;
                localStorage.setItem('autoSizeMobile', enabled);
                
                if (this.isMobile) {
                    if (enabled) {
                        this.applyMobileSize();
                    } else {
                        this.restoreDesktopSize();
                    }
                }
            },
            
            loadSizeSettings() {
                const savedSize = localStorage.getItem('avatarSize');
                const savedAutoMobile = localStorage.getItem('autoSizeMobile');
                
                if (savedSize) {
                    this.avatarSize = parseInt(savedSize);
                    const slider = document.getElementById('avatarSizeSlider');
                    if (slider) {
                        slider.value = this.avatarSize;
                        document.getElementById('sizeDisplay').textContent = `${this.avatarSize}px`;
                    }
                }
                
                if (savedAutoMobile !== null) {
                    this.autoSizeMobile = savedAutoMobile === 'true';
                    const checkbox = document.getElementById('autoSizeMobile');
                    if (checkbox) {
                        checkbox.checked = this.autoSizeMobile;
                    }
                }
                
                if (!this.isMobile || !this.autoSizeMobile) {
                    document.documentElement.style.setProperty('--avatar-current-size', `${this.avatarSize}px`);
                }
            },

            // === 工具函數 ===
            isTimeOverlap(start1, end1, start2, end2) {
                const s1 = this.timeToMinutes(start1);
                const e1 = this.timeToMinutes(end1);
                const s2 = this.timeToMinutes(start2);
                const e2 = this.timeToMinutes(end2);
                
                let e1Adjusted = e1 < s1 ? e1 + 1440 : e1;
                let e2Adjusted = e2 < s2 ? e2 + 1440 : e2;
                
                return (s1 < e2Adjusted && s2 < e1Adjusted);
            },

            timeToMinutes(time) {
                const [hours, minutes] = time.split(':').map(Number);
                return hours * 60 + minutes;
            },

            getEmployeeById(id) { 
                return this.employees.find(e => e.id === id); 
            },

            getEmployeeName(id) {
                const emp = this.getEmployeeById(id);
                return emp ? emp.name : '未知';
            },
            
            previousMonth() { 
                this.currentMonth.setMonth(this.currentMonth.getMonth() - 1); 
                this.renderCalendar(); 
            },
            
            nextMonth() { 
                this.currentMonth.setMonth(this.currentMonth.getMonth() + 1); 
                this.renderCalendar(); 
            },

            togglePanel() { 
                document.getElementById('floatingPanel').classList.toggle('open'); 
            },
            
            setupPanelDrag() {
                const panel = document.getElementById('floatingPanel');
                const header = document.getElementById('panelHeader');
                let isDragging = false, offset = { x: 0, y: 0 };
                
                header.onmousedown = (e) => {
                    if (e.target.tagName === 'BUTTON' || e.target.parentElement?.tagName === 'BUTTON') return;
                    isDragging = true;
                    offset = { x: e.clientX - panel.offsetLeft, y: e.clientY - panel.offsetTop };
                    header.style.cursor = 'grabbing';
                };
                
                document.onmousemove = (e) => {
                    if (!isDragging) return;
                    let newX = e.clientX - offset.x, newY = e.clientY - offset.y;
                    const maxX = window.innerWidth - panel.offsetWidth;
                    const maxY = window.innerHeight - panel.offsetHeight;
                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));
                    panel.style.left = `${newX}px`;
                    panel.style.top = `${newY}px`;
                    panel.style.right = 'auto'; 
                    panel.style.bottom = 'auto';
                };
                
                document.onmouseup = () => { 
                    isDragging = false; 
                    header.style.cursor = 'grab'; 
                };
            },

            // === 同步狀態管理 ===
            updateSyncStatus(connected) {
                this.isConnected = connected;
                const statusEl = document.getElementById('syncStatus');
                const statusText = document.getElementById('syncStatusText');
                
                if (connected) {
                    statusEl.classList.add('connected');
                    statusText.textContent = '已連線';
                } else {
                    statusEl.classList.remove('connected');
                    statusText.textContent = '未連線';
                }
                
                if (this.lastSyncTime) {
                    document.getElementById('lastSyncTime').textContent = 
                        new Date(this.lastSyncTime).toLocaleTimeString('zh-TW');
                }
            },

            loadSyncStatus() {
                const lastSync = localStorage.getItem('lastSync');
                
                if (lastSync) {
                    this.lastSyncTime = lastSync;
                    document.getElementById('lastSyncTime').textContent = 
                        new Date(lastSync).toLocaleTimeString('zh-TW');
                }
                
                // 如果有即時模式設定，恢復狀態
                const realtimeEnabled = localStorage.getItem('realtimeMode');
                if (realtimeEnabled === 'true' && this.scriptUrl) {
                    this.enableRealTimeMode();
                }
            },

            handleStorageChange() {
                // 如果不在即時模式，才從本地載入
                if (!this.realTimeMode) {
                    this.loadLocalData();
                    this.renderAll();
                }
            },

            // === 匯出功能 ===
            exportCSV() {
                const year = this.currentMonth.getFullYear();
                const month = this.currentMonth.getMonth() + 1;
                
                let csv = '\ufeff';
                csv += '日期,星期,時間,員工,類型,備註\n';
                
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                
                Object.keys(this.schedules).forEach(date => {
                    if (date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
                        const dateObj = new Date(date + 'T00:00:00');
                        const weekday = weekdays[dateObj.getDay()];
                        
                        this.schedules[date].forEach(schedule => {
                            const employee = this.employees.find(e => e.id === schedule.employeeId);
                            if (employee) {
                                csv += `${date},週${weekday},${schedule.startTime}-${schedule.endTime},${employee.name},${employee.type === 'fulltime' ? '正職' : 'PT'},${schedule.notes || ''}\n`;
                            }
                        });
                    }
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `排班表_${year}年${month}月.csv`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showToast('CSV 檔案已匯出', 'success');
            },

            // === 工具函數 ===
            isUserEditing() {
                // 檢查是否有開啟的模態框
                return document.querySelector('.modal.show') !== null;
            },

            generateDataHash(data) {
                const str = JSON.stringify(data);
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                    const char = str.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString();
            },

            // === UI 通知 ===
            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                
                let icon = 'info';
                if (type === 'success') icon = 'check_circle';
                if (type === 'error') icon = 'error';
                if (type === 'warning') icon = 'warning';
                
                toast.innerHTML = `
                    <span class="material-icons">${icon}</span>
                    ${message}
                `;
                
                toast.className = 'toast show';
                
                if (type === 'error') {
                    toast.classList.add('error');
                } else if (type === 'success') {
                    toast.classList.add('success');
                } else if (type === 'warning') {
                    toast.classList.add('warning');
                }
                
                clearTimeout(this.toastTimeout);
                this.toastTimeout = setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        };

        // === 初始化 ===
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

        // ESC 鍵關閉模態框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
            }
        });

        // 點擊模態框外部關閉
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });

        // 防止拖曳面板時選取文字
        document.getElementById('panelHeader').addEventListener('selectstart', (e) => {
            e.preventDefault();
        });

        // 頁面關閉前儲存即時同步狀態
        window.addEventListener('beforeunload', () => {
            localStorage.setItem('realtimeMode', App.realTimeMode.toString());
            
            // 停止自動同步
            if (App.autoSyncInterval) {
                clearInterval(App.autoSyncInterval);
            }
        });

        // 頁面可見性變化時的處理
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // 頁面隱藏時暫停同步
                if (App.autoSyncInterval) {
                    App.stopAutoSync();
                }
            } else {
                // 頁面顯示時恢復同步
                if (App.realTimeMode) {
                    App.startAutoSync();
                    // 立即同步一次
                    App.syncWithSheets();
                }
            }
        });
    </script>
</body>
</html>
