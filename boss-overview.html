<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Bleu 班表系統 - 老闆總覽">
    <meta name="author" content="DK0124">
    <title>Bleu 班表系統 - 老闆總覽</title>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23003D52' d='M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z'/></svg>">
    
    <style>
        /* Bleu 班表系統 色系 */
        :root {
            --bleu-primary: #003D52;
            --bleu-secondary: #83968B;
            --bleu-accent: #EE7836;
            --bleu-light: #BCDBE4;
            --bleu-white: #FFFFFF;
            --bleu-bg: #F8FAFC;
            --bleu-gray-light: #EFF6F9;
            --bleu-gray: #DDE4E7;
            --bleu-gray-dark: #6B7C74;
            --bleu-text: #2C3E50;
            --bleu-shadow: 0 4px 15px rgba(0, 61, 82, 0.07);
            --bleu-shadow-hover: 0 6px 25px rgba(0, 61, 82, 0.1);
            --bleu-radius: 12px;
            --bleu-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        html { 
            scroll-behavior: smooth; 
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bleu-bg);
            color: var(--bleu-text);
            line-height: 1.6;
            overscroll-behavior: none;
        }

        .material-icons, 
        .material-icons-outlined { 
            vertical-align: middle; 
            font-size: 20px; 
        }
        
        .btn .material-icons, 
        .btn .material-icons-outlined { 
            margin-right: 6px; 
        }

        .app { 
            padding: 25px; 
        }

        /* 同步狀態指示器 */
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bleu-white);
            border-radius: 20px;
            box-shadow: var(--bleu-shadow);
            z-index: 999;
            transition: var(--bleu-transition);
        }

        .sync-indicator.syncing {
            background: #FFF9C4;
        }

        .sync-indicator.success {
            background: #E8F5E9;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .sync-text {
            font-size: 12px;
            color: var(--bleu-gray-dark);
            font-weight: 500;
        }

        .page-title { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        
        .page-title h1 { 
            font-size: 28px; 
            font-weight: 700; 
            color: var(--bleu-primary); 
        }
        
        .page-title .material-icons { 
            font-size: 32px; 
            color: var(--bleu-primary); 
        }

        .btn {
            padding: 8px 18px; 
            border: none; 
            border-radius: 8px; 
            font-size: 14px;
            font-weight: 600; 
            cursor: pointer; 
            transition: var(--bleu-transition);
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            white-space: nowrap;
        }
        
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        
        .btn-primary { 
            background: var(--bleu-primary); 
            color: white; 
        }
        
        .btn-primary:hover:not(:disabled) { 
            background: #002A3A; 
            transform: translateY(-2px); 
            box-shadow: var(--bleu-shadow-hover); 
        }
        
        .btn-secondary {
            background: var(--bleu-secondary);
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #6B7C74;
        }
        
        .btn-accent { 
            background: var(--bleu-accent); 
            color: white; 
        }
        
        .btn-accent:hover:not(:disabled) { 
            background: #D66327; 
        }

        .btn-success {
            background: #28A745;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #218838;
        }

        /* 主容器 */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* 快速操作欄 */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }

        /* 統計卡片 */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--bleu-white);
            border-radius: var(--bleu-radius);
            padding: 20px;
            box-shadow: var(--bleu-shadow);
            transition: var(--bleu-transition);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--bleu-shadow-hover);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--bleu-primary);
        }

        .stat-card.accent::before {
            background: var(--bleu-accent);
        }

        .stat-card.success::before {
            background: #28A745;
        }

        .stat-card.warning::before {
            background: #FFC107;
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bleu-light);
            color: var(--bleu-primary);
        }

        .stat-card.accent .stat-icon {
            background: rgba(238, 120, 54, 0.1);
            color: var(--bleu-accent);
        }

        .stat-card.success .stat-icon {
            background: rgba(40, 167, 69, 0.1);
            color: #28A745;
        }

        .stat-card.warning .stat-icon {
            background: rgba(255, 193, 7, 0.1);
            color: #FFC107;
        }

        .stat-content {
            margin-bottom: 10px;
        }

        .stat-title {
            font-size: 13px;
            color: var(--bleu-gray-dark);
            font-weight: 500;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--bleu-primary);
            line-height: 1;
        }

        .stat-footer {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 12px;
            color: var(--bleu-gray-dark);
        }

        .stat-change {
            display: flex;
            align-items: center;
            gap: 3px;
            font-weight: 600;
        }

        .stat-change.up {
            color: #28A745;
        }

        .stat-change.down {
            color: #DC3545;
        }

        /* 圖表容器 */
        .chart-container {
            background: var(--bleu-white);
            border-radius: var(--bleu-radius);
            padding: 20px;
            box-shadow: var(--bleu-shadow);
            margin-bottom: 25px;
        }

        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--bleu-gray-light);
        }

        .chart-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--bleu-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* 今日班表 */
        .today-schedule {
            background: var(--bleu-white);
            border-radius: var(--bleu-radius);
            padding: 20px;
            box-shadow: var(--bleu-shadow);
            margin-bottom: 25px;
        }

        .schedule-timeline {
            position: relative;
            padding: 20px 0;
        }

        .time-axis {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            padding: 0 10px;
            font-size: 12px;
            color: var(--bleu-gray-dark);
        }

        .employee-timeline {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            background: var(--bleu-gray-light);
            border-radius: 8px;
            padding: 10px;
        }

        .employee-label {
            min-width: 100px;
            font-weight: 600;
            color: var(--bleu-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .employee-avatar-small {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--bleu-accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
        }

        .timeline-bar {
            flex: 1;
            height: 30px;
            position: relative;
            background: var(--bleu-white);
            border-radius: 6px;
            margin-left: 10px;
        }

        .shift-block {
            position: absolute;
            height: 100%;
            background: var(--bleu-primary);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: 600;
            transition: var(--bleu-transition);
        }

        .shift-block:hover {
            transform: scaleY(1.1);
            z-index: 10;
            box-shadow: var(--bleu-shadow);
        }

        /* 員工狀態表格 */
        .employee-table-container {
            background: var(--bleu-white);
            border-radius: var(--bleu-radius);
            padding: 20px;
            box-shadow: var(--bleu-shadow);
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table th {
            background: var(--bleu-gray-light);
            color: var(--bleu-primary);
            font-weight: 600;
            padding: 12px;
            text-align: left;
            font-size: 13px;
            border-bottom: 2px solid var(--bleu-gray);
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid var(--bleu-gray-light);
            font-size: 14px;
        }

        .data-table tr:hover {
            background: var(--bleu-gray-light);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge.working {
            background: rgba(40, 167, 69, 0.1);
            color: #28A745;
        }

        .badge.off {
            background: var(--bleu-gray-light);
            color: var(--bleu-gray-dark);
        }

        .badge.fulltime {
            background: var(--bleu-light);
            color: var(--bleu-primary);
        }

        .badge.parttime {
            background: rgba(238, 120, 54, 0.1);
            color: var(--bleu-accent);
        }

        /* 圖表佔位符 */
        .chart-placeholder {
            height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bleu-gray-light);
            border-radius: 8px;
            color: var(--bleu-gray-dark);
        }

        /* Toast 通知 */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bleu-primary);
            color: white;
            padding: 14px 24px;
            border-radius: 8px;
            opacity: 0;
            transition: var(--bleu-transition);
            z-index: 2000;
            box-shadow: 0 4px 20px rgba(0, 61, 82, 0.3);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            background: #28A745;
        }

        .toast.error {
            background: #DC3545;
        }

        /* RWD 響應式設計 */
        @media (max-width: 768px) {
            .app {
                padding: 10px;
            }

            .page-title h1 {
                font-size: 20px;
            }

            .sync-indicator {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .quick-actions {
                flex-direction: column;
            }

            .btn {
                padding: 6px 10px;
                font-size: 12px;
                width: 100%;
            }

            .employee-timeline {
                flex-direction: column;
                align-items: flex-start;
            }

            .timeline-bar {
                width: 100%;
                margin-left: 0;
                margin-top: 10px;
            }

            .data-table {
                font-size: 12px;
            }

            .data-table th,
            .data-table td {
                padding: 8px;
            }
        }
    </style>
</head>
<body>
    <!-- 同步狀態指示器 -->
    <div class="sync-indicator" id="syncIndicator">
        <div class="sync-dot"></div>
        <span class="sync-text">已連線</span>
    </div>

    <div class="app">
        <div class="main-container">
            <!-- 頁面標題 -->
            <div class="page-title">
                <span class="material-icons">dashboard</span>
                <h1>營運總覽儀表板</h1>
            </div>

            <!-- 快速操作 -->
            <div class="quick-actions">
                <button class="btn btn-primary" onclick="BossOverview.refreshData()">
                    <span class="material-icons">refresh</span>
                    重新整理
                </button>
                <button class="btn btn-accent" onclick="BossOverview.exportMonthlyReport()">
                    <span class="material-icons">description</span>
                    月報表
                </button>
                <button class="btn btn-success" onclick="BossOverview.exportAnalytics()">
                    <span class="material-icons">analytics</span>
                    匯出分析
                </button>
            </div>

            <!-- 關鍵指標 -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <span class="material-icons">groups</span>
                        </div>
                    </div>
                    <div class="stat-content">
                        <div class="stat-title">今日出勤</div>
                        <div class="stat-value" id="todayWorking">0</div>
                    </div>
                    <div class="stat-footer">
                        <span>總員工數：</span>
                        <span id="totalEmployees">0</span>
                    </div>
                </div>

                <div class="stat-card accent">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <span class="material-icons">schedule</span>
                        </div>
                    </div>
                    <div class="stat-content">
                        <div class="stat-title">本月總工時</div>
                        <div class="stat-value" id="monthlyHours">0</div>
                    </div>
                    <div class="stat-footer">
                        <span class="stat-change up">
                            <span class="material-icons" style="font-size: 14px;">trending_up</span>
                            <span id="hoursChange">+12%</span>
                        </span>
                        <span>較上月</span>
                    </div>
                </div>

                <div class="stat-card success">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <span class="material-icons">event_available</span>
                        </div>
                    </div>
                    <div class="stat-content">
                        <div class="stat-title">本月排班率</div>
                        <div class="stat-value" id="coverageRate">0%</div>
                    </div>
                    <div class="stat-footer">
                        <span>已排班天數：</span>
                        <span id="scheduledDays">0</span>
                    </div>
                </div>

                <div class="stat-card warning">
                    <div class="stat-header">
                        <div class="stat-icon">
                            <span class="material-icons">trending_up</span>
                        </div>
                    </div>
                    <div class="stat-content">
                        <div class="stat-title">平均日工時</div>
                        <div class="stat-value" id="avgDailyHours">0</div>
                    </div>
                    <div class="stat-footer">
                        <span>小時/日</span>
                    </div>
                </div>
            </div>

            <!-- 今日班表時間軸 -->
            <div class="today-schedule">
                <div class="chart-header">
                    <div class="chart-title">
                        <span class="material-icons">timeline</span>
                        今日班表時間軸
                    </div>
                    <div id="currentTime" style="color: var(--bleu-accent); font-weight: 600;"></div>
                </div>
                <div class="schedule-timeline">
                    <div class="time-axis">
                        <span>00:00</span>
                        <span>06:00</span>
                        <span>12:00</span>
                        <span>18:00</span>
                        <span>24:00</span>
                    </div>
                    <div id="timelineContainer">
                        <!-- 動態生成的時間軸 -->
                    </div>
                </div>
            </div>

            <!-- 圖表區域 -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 25px;">
                <!-- 本週工時分布 -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">
                            <span class="material-icons">bar_chart</span>
                            本週工時分布
                        </div>
                    </div>
                    <div id="weeklyChart" class="chart-placeholder">
                        <canvas id="weeklyHoursChart" width="400" height="300"></canvas>
                    </div>
                </div>

                <!-- 員工類型分布 -->
                <div class="chart-container">
                    <div class="chart-header">
                        <div class="chart-title">
                            <span class="material-icons">pie_chart</span>
                            員工組成分析
                        </div>
                    </div>
                    <div id="employeeChart" class="chart-placeholder">
                        <canvas id="employeeTypeChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>

            <!-- 員工狀態表格 -->
            <div class="employee-table-container">
                <div class="chart-header">
                    <div class="chart-title">
                        <span class="material-icons">table_rows</span>
                        員工排班狀態總覽
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>員工姓名</th>
                            <th>類型</th>
                            <th>今日狀態</th>
                            <th>本週工時</th>
                            <th>本月工時</th>
                            <th>本月班次</th>
                        </tr>
                    </thead>
                    <tbody id="employeeTableBody">
                        <!-- 動態生成的表格內容 -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div class="toast" id="toast"></div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        const BossOverview = {
            scriptUrl: 'https://script.google.com/macros/s/AKfycbzDImzTB17fp5FViVwXtIzxUrH-ByJ4p2lRrk__YPG-DJctKsE2YRZ3CqXlrHkZeZbW3A/exec',
            
            employees: [],
            schedules: {},
            shifts: [],
            charts: {},
            
            async init() {
                await this.loadData();
                this.updateDashboard();
                this.renderCharts();
                this.updateCurrentTime();
                
                // 每分鐘更新時間
                setInterval(() => this.updateCurrentTime(), 60000);
                
                // 每30秒自動刷新資料
                setInterval(() => this.loadData(true), 30000);
            },
            
            async loadData(silent = false) {
                if (!silent) this.showToast('載入中...', 'info');
                
                try {
                    const response = await fetch(`${this.scriptUrl}?action=getRealtimeData`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        this.employees = result.data.employees || [];
                        this.shifts = result.data.shifts || [];
                        
                        // 處理排班資料
                        if (Array.isArray(result.data.schedules)) {
                            this.schedules = {};
                            result.data.schedules.forEach(schedule => {
                                const date = schedule.date;
                                if (!this.schedules[date]) {
                                    this.schedules[date] = [];
                                }
                                this.schedules[date].push({
                                    employeeId: schedule.employeeId,
                                    startTime: schedule.startTime,
                                    endTime: schedule.endTime,
                                    notes: schedule.notes || ''
                                });
                            });
                        } else {
                            this.schedules = result.data.schedules || {};
                        }
                        
                        if (!silent) {
                            this.showToast('資料已更新', 'success');
                            this.updateSyncStatus(true);
                        }
                        
                        // 更新所有顯示
                        this.updateDashboard();
                        this.renderCharts();
                    }
                } catch (error) {
                    console.error('載入失敗:', error);
                    if (!silent) {
                        this.showToast('載入失敗，使用離線資料', 'error');
                        this.updateSyncStatus(false);
                    }
                    this.loadLocalData();
                }
            },
            
            loadLocalData() {
                const data = localStorage.getItem('bleuScheduleData');
                if (data) {
                    const parsed = JSON.parse(data);
                    this.employees = parsed.employees || [];
                    this.schedules = parsed.schedules || {};
                    this.shifts = parsed.shifts || [];
                    this.updateDashboard();
                    this.renderCharts();
                }
            },
            
            // 改進的顏色生成函數
            generateDistinctColor(id, name) {
                const distinctColors = [
                    "#E91E63", "#9C27B0", "#673AB7", "#3F51B5", "#2196F3",
                    "#03A9F4", "#00BCD4", "#009688", "#4CAF50", "#8BC34A",
                    "#CDDC39", "#FFC107", "#FF9800", "#FF5722", "#795548",
                    "#607D8B", "#F44336", "#00ACC1", "#7B1FA2", "#303F9F",
                    "#0288D1", "#0097A7", "#00796B", "#388E3C", "#689F38",
                    "#AFB42B", "#FFA000", "#F57C00", "#E64A19", "#5D4037",
                    "#455A64", "#C2185B", "#7C4DFF", "#536DFE", "#448AFF",
                    "#40C4FF", "#18FFFF", "#64FFDA", "#69F0AE", "#B2FF59",
                    "#EEFF41", "#FFD740", "#FFAB40", "#FF6E40"
                ];
                
                const hash = (id + (name || '')).split('').reduce((acc, char) => {
                    return char.charCodeAt(0) + ((acc << 5) - acc);
                }, 0);
                
                return distinctColors[Math.abs(hash) % distinctColors.length];
            },
            
            updateDashboard() {
                const today = new Date().toISOString().slice(0, 10);
                const currentMonth = new Date();
                const year = currentMonth.getFullYear();
                const month = currentMonth.getMonth();
                const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
                
                // 計算今日出勤
                let todayWorking = 0;
                if (this.schedules[today]) {
                    const uniqueEmployees = new Set(this.schedules[today].map(s => s.employeeId));
                    todayWorking = uniqueEmployees.size;
                }
                
                // 計算本月總工時
                let monthlyMinutes = 0;
                let scheduledDaysSet = new Set();
                let employeeStats = {};
                
                Object.keys(this.schedules).forEach(date => {
                    if (date.startsWith(monthKey)) {
                        scheduledDaysSet.add(date);
                        this.schedules[date].forEach(schedule => {
                            const minutes = this.calculateMinutes(schedule.startTime, schedule.endTime);
                            monthlyMinutes += minutes;
                            
                            // 統計每個員工
                            if (!employeeStats[schedule.employeeId]) {
                                employeeStats[schedule.employeeId] = {
                                    weekMinutes: 0,
                                    monthMinutes: 0,
                                    monthShifts: 0,
                                    todaySchedule: null
                                };
                            }
                            employeeStats[schedule.employeeId].monthMinutes += minutes;
                            employeeStats[schedule.employeeId].monthShifts++;
                            
                            // 本週統計
                            const scheduleDate = new Date(date);
                            const weekAgo = new Date();
                            weekAgo.setDate(weekAgo.getDate() - 7);
                            if (scheduleDate >= weekAgo) {
                                employeeStats[schedule.employeeId].weekMinutes += minutes;
                            }
                            
                            // 今日排班
                            if (date === today) {
                                employeeStats[schedule.employeeId].todaySchedule = schedule;
                            }
                        });
                    }
                });
                
                // 更新統計卡片
                document.getElementById('todayWorking').textContent = todayWorking;
                document.getElementById('totalEmployees').textContent = this.employees.length;
                document.getElementById('monthlyHours').textContent = Math.floor(monthlyMinutes / 60);
                document.getElementById('scheduledDays').textContent = scheduledDaysSet.size;
                
                // 計算覆蓋率
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                const coverageRate = Math.round((scheduledDaysSet.size / daysInMonth) * 100);
                document.getElementById('coverageRate').textContent = coverageRate + '%';
                
                // 平均日工時
                const avgDailyHours = scheduledDaysSet.size > 0 
                    ? Math.round((monthlyMinutes / 60) / scheduledDaysSet.size * 10) / 10
                    : 0;
                document.getElementById('avgDailyHours').textContent = avgDailyHours;
                
                // 渲染今日時間軸
                this.renderTimeline(today);
                
                // 渲染員工表格
                this.renderEmployeeTable(employeeStats);
            },
            
            renderTimeline(today) {
                const container = document.getElementById('timelineContainer');
                container.innerHTML = '';
                
                const todaySchedules = this.schedules[today] || [];
                const employeeSchedules = {};
                
                // 組織每個員工的排班
                todaySchedules.forEach(schedule => {
                    if (!employeeSchedules[schedule.employeeId]) {
                        employeeSchedules[schedule.employeeId] = [];
                    }
                    employeeSchedules[schedule.employeeId].push(schedule);
                });
                
                // 渲染每個員工的時間軸
                Object.keys(employeeSchedules).forEach(employeeId => {
                    const employee = this.employees.find(e => e.id == employeeId);
                    if (!employee) return;
                    
                    const timeline = document.createElement('div');
                    timeline.className = 'employee-timeline';
                    
                    const avatarColor = this.generateDistinctColor(employee.id, employee.name);
                    
                    const label = document.createElement('div');
                    label.className = 'employee-label';
                    label.innerHTML = `
                        <div class="employee-avatar-small" style="background: ${avatarColor}">
                            ${employee.avatarText || employee.name.charAt(0)}
                        </div>
                        ${employee.name}
                    `;
                    
                    const bar = document.createElement('div');
                    bar.className = 'timeline-bar';
                    
                    employeeSchedules[employeeId].forEach(schedule => {
                        const block = document.createElement('div');
                        block.className = 'shift-block';
                        
                        const startMinutes = this.timeToMinutes(schedule.startTime);
                        const endMinutes = this.timeToMinutes(schedule.endTime);
                        const duration = endMinutes > startMinutes ? endMinutes - startMinutes : (1440 - startMinutes) + endMinutes;
                        
                        const left = (startMinutes / 1440) * 100;
                        const width = (duration / 1440) * 100;
                        
                        block.style.left = `${left}%`;
                        block.style.width = `${width}%`;
                        block.style.background = avatarColor;
                        block.textContent = `${schedule.startTime}-${schedule.endTime}`;
                        block.title = schedule.notes || '無備註';
                        
                        bar.appendChild(block);
                    });
                    
                    timeline.appendChild(label);
                    timeline.appendChild(bar);
                    container.appendChild(timeline);
                });
                
                if (Object.keys(employeeSchedules).length === 0) {
                    container.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--bleu-gray-dark);">今日無排班</div>';
                }
            },
            
            renderEmployeeTable(employeeStats) {
                const tbody = document.getElementById('employeeTableBody');
                tbody.innerHTML = '';
                
                this.employees.forEach(employee => {
                    const stats = employeeStats[employee.id] || {
                        weekMinutes: 0,
                        monthMinutes: 0,
                        monthShifts: 0,
                        todaySchedule: null
                    };
                    
                    const avatarColor = this.generateDistinctColor(employee.id, employee.name);
                    
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="employee-avatar-small" style="background: ${avatarColor}">
                                    ${employee.avatarText || employee.name.charAt(0)}
                                </div>
                                ${employee.name}
                            </div>
                        </td>
                        <td>
                            <span class="badge ${employee.type === 'fulltime' ? 'fulltime' : 'parttime'}">
                                ${employee.type === 'fulltime' ? '正職' : '兼職'}
                            </span>
                        </td>
                        <td>
                            <span class="badge ${stats.todaySchedule ? 'working' : 'off'}">
                                ${stats.todaySchedule ? `${stats.todaySchedule.startTime}-${stats.todaySchedule.endTime}` : '休假'}
                            </span>
                        </td>
                        <td>${Math.floor(stats.weekMinutes / 60)} 小時</td>
                        <td>${Math.floor(stats.monthMinutes / 60)} 小時</td>
                        <td>${stats.monthShifts} 次</td>
                    `;
                    tbody.appendChild(tr);
                });
            },
            
            renderCharts() {
                // 本週工時分布圖
                this.renderWeeklyChart();
                
                // 員工類型分布圖
                this.renderEmployeeTypeChart();
            },
            
            renderWeeklyChart() {
                const canvas = document.getElementById('weeklyHoursChart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                
                // 計算本週每日工時
                const today = new Date();
                const weekDays = ['日', '一', '二', '三', '四', '五', '六'];
                const labels = [];
                const data = [];
                
                for (let i = 6; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(today.getDate() - i);
                    const dateStr = date.toISOString().slice(0, 10);
                    const daySchedules = this.schedules[dateStr] || [];
                    
                    let dayMinutes = 0;
                    daySchedules.forEach(schedule => {
                        dayMinutes += this.calculateMinutes(schedule.startTime, schedule.endTime);
                    });
                    
                    labels.push(`週${weekDays[date.getDay()]}`);
                    data.push(Math.round(dayMinutes / 60 * 10) / 10);
                }
                
                // 銷毀舊圖表
                if (this.charts.weekly) {
                    this.charts.weekly.destroy();
                }
                
                // 建立新圖表
                this.charts.weekly = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '工時（小時）',
                            data: data,
                            backgroundColor: 'rgba(0, 61, 82, 0.8)',
                            borderColor: 'rgba(0, 61, 82, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return value + ' hr';
                                    }
                                }
                            }
                        }
                    }
                });
            },
            
            renderEmployeeTypeChart() {
                const canvas = document.getElementById('employeeTypeChart');
                if (!canvas) return;
                
                const ctx = canvas.getContext('2d');
                
                // 計算員工類型分布
                let fulltime = 0;
                let parttime = 0;
                
                this.employees.forEach(emp => {
                    if (emp.type === 'fulltime') {
                        fulltime++;
                    } else {
                        parttime++;
                    }
                });
                
                // 銷毀舊圖表
                if (this.charts.employeeType) {
                    this.charts.employeeType.destroy();
                }
                
                // 建立新圖表
                this.charts.employeeType = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['正職', '兼職'],
                        datasets: [{
                            data: [fulltime, parttime],
                            backgroundColor: [
                                'rgba(0, 61, 82, 0.8)',
                                'rgba(238, 120, 54, 0.8)'
                            ],
                            borderColor: [
                                'rgba(0, 61, 82, 1)',
                                'rgba(238, 120, 54, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            },
            
            updateCurrentTime() {
                const now = new Date();
                const timeStr = now.toLocaleTimeString('zh-TW', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                document.getElementById('currentTime').textContent = `現在時間：${timeStr}`;
            },
            
            calculateMinutes(startTime, endTime) {
                const [startH, startM] = startTime.split(':').map(Number);
                const [endH, endM] = endTime.split(':').map(Number);
                let minutes = (endH * 60 + endM) - (startH * 60 + startM);
                if (minutes < 0) minutes += 24 * 60;
                return minutes;
            },
            
            timeToMinutes(time) {
                const [hours, minutes] = time.split(':').map(Number);
                return hours * 60 + minutes;
            },
            
            async refreshData() {
                await this.loadData();
            },
            
            exportMonthlyReport() {
                const year = new Date().getFullYear();
                const month = new Date().getMonth() + 1;
                
                let csv = '\ufeff';
                csv += `Bleu班表系統 - ${year}年${month}月營運報告\n\n`;
                
                // 總覽統計
                csv += '=== 總覽統計 ===\n';
                csv += `總員工數,${this.employees.length}\n`;
                csv += `本月總工時,${document.getElementById('monthlyHours').textContent} 小時\n`;
                csv += `排班覆蓋率,${document.getElementById('coverageRate').textContent}\n`;
                csv += `平均日工時,${document.getElementById('avgDailyHours').textContent} 小時\n\n`;
                
                // 員工明細
                csv += '=== 員工工時明細 ===\n';
                csv += '員工姓名,類型,本月工時,本月班次\n';
                
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                const employeeStats = {};
                
                Object.keys(this.schedules).forEach(date => {
                    if (date.startsWith(monthKey)) {
                        this.schedules[date].forEach(schedule => {
                            if (!employeeStats[schedule.employeeId]) {
                                employeeStats[schedule.employeeId] = {
                                    minutes: 0,
                                    shifts: 0
                                };
                            }
                            employeeStats[schedule.employeeId].minutes += 
                                this.calculateMinutes(schedule.startTime, schedule.endTime);
                            employeeStats[schedule.employeeId].shifts++;
                        });
                    }
                });
                
                this.employees.forEach(emp => {
                    const stats = employeeStats[emp.id] || { minutes: 0, shifts: 0 };
                    csv += `${emp.name},${emp.type === 'fulltime' ? '正職' : '兼職'},`;
                    csv += `${Math.floor(stats.minutes / 60)},${stats.shifts}\n`;
                });
                
                // 下載檔案
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Bleu營運報告_${year}年${month}月.csv`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showToast('報告已匯出', 'success');
            },
            
            exportAnalytics() {
                this.showToast('詳細分析報告生成中...', 'info');
                // 可以加入更詳細的分析報告功能
                setTimeout(() => {
                    this.exportMonthlyReport();
                }, 1000);
            },
            
            updateSyncStatus(connected) {
                const indicator = document.getElementById('syncIndicator');
                const text = indicator.querySelector('.sync-text');
                
                if (connected) {
                    indicator.classList.add('success');
                    text.textContent = '已連線';
                } else {
                    indicator.classList.remove('success');
                    text.textContent = '離線模式';
                }
            },
            
            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'toast show';
                if (type === 'success') toast.classList.add('success');
                if (type === 'error') toast.classList.add('error');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        };
        
        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            BossOverview.init();
        });
    </script>
</body>
</html>
