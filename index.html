<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Bleu 班表系統 - 現代化的排班解決方案">
    <meta name="author" content="DK0124">
    <title>Bleu 班表系統</title>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23003D52' d='M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z'/></svg>">
    
    <style>
        /* Bleu 班表系統 色系 */
        :root {
            --bleu-primary: #003D52;
            --bleu-secondary: #83968B;
            --bleu-accent: #EE7836;
            --bleu-light: #BCDBE4;
            --bleu-white: #FFFFFF;
            --bleu-bg: #F8FAFC;
            --bleu-gray-light: #EFF6F9;
            --bleu-gray: #DDE4E7;
            --bleu-gray-dark: #6B7C74;
            --bleu-text: #2C3E50;
            --bleu-shadow: 0 4px 15px rgba(0, 61, 82, 0.07);
            --bleu-shadow-hover: 0 6px 25px rgba(0, 61, 82, 0.1);
            --bleu-radius: 12px;
            --bleu-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        html { 
            scroll-behavior: smooth; 
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bleu-bg);
            color: var(--bleu-text);
            line-height: 1.6;
            overscroll-behavior: none;
        }

        .material-icons, 
        .material-icons-outlined { 
            vertical-align: middle; 
            font-size: 20px; 
        }
        
        .btn .material-icons, 
        .btn .material-icons-outlined { 
            margin-right: 6px; 
        }

        .app { 
            padding: 25px; 
        }

        .page-title { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        
        .page-title h1 { 
            font-size: 28px; 
            font-weight: 700; 
            color: var(--bleu-primary); 
        }
        
        .page-title .material-icons { 
            font-size: 32px; 
            color: var(--bleu-primary); 
        }

        .btn {
            padding: 8px 18px; 
            border: none; 
            border-radius: 8px; 
            font-size: 14px;
            font-weight: 600; 
            cursor: pointer; 
            transition: var(--bleu-transition);
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            white-space: nowrap;
        }
        
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
            transform: none; 
            box-shadow: none; 
        }
        
        .btn-primary { 
            background: var(--bleu-primary); 
            color: white; 
        }
        
        .btn-primary:hover:not(:disabled) { 
            background: #002A3A; 
            transform: translateY(-2px); 
            box-shadow: var(--bleu-shadow-hover); 
        }
        
        .btn-accent { 
            background: var(--bleu-accent); 
            color: white; 
        }
        
        .btn-accent:hover:not(:disabled) { 
            background: #D66327; 
            transform: translateY(-2px); 
            box-shadow: var(--bleu-shadow-hover); 
        }
        
        .btn-secondary {
            background: var(--bleu-secondary);
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #6B7C74;
        }
        
        .btn-icon { 
            padding: 8px; 
            border-radius: 50%; 
            background: transparent; 
            color: var(--bleu-primary); 
        }
        
        .btn-icon:hover { 
            background: var(--bleu-light); 
        }
        
        .btn-icon .material-icons { 
            margin: 0; 
        }

        .calendar-container {
            background: var(--bleu-white); 
            border-radius: var(--bleu-radius);
            padding: 25px; 
            box-shadow: var(--bleu-shadow);
        }
        
        .calendar-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            margin-bottom: 25px; 
            padding-bottom: 15px; 
            border-bottom: 2px solid var(--bleu-gray-light);
        }
        
        .calendar-nav { 
            display: flex; 
            align-items: center; 
            gap: 20px; 
        }
        
        .calendar-title { 
            font-size: 22px; 
            font-weight: 600; 
            color: var(--bleu-primary); 
        }
        
        .calendar-actions { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }

        .calendar-grid {
            display: grid; 
            grid-template-columns: repeat(7, 1fr);
            border-top: 1px solid var(--bleu-gray); 
            border-left: 1px solid var(--bleu-gray);
        }
        
        .calendar-cell {
            border-right: 1px solid var(--bleu-gray); 
            border-bottom: 1px solid var(--bleu-gray);
            min-height: 120px; 
            padding: 8px; 
            display: flex; 
            flex-direction: column;
            transition: var(--bleu-transition); 
            position: relative;
        }
        
        .weekday-header {
            text-align: center; 
            font-weight: 600; 
            font-size: 13px;
            color: var(--bleu-secondary); 
            padding: 10px 0;
        }
        
        .date-cell { 
            cursor: pointer; 
        }
        
        .date-cell:hover { 
            background: var(--bleu-gray-light); 
        }
        
        .date-number { 
            font-weight: 600; 
            color: var(--bleu-text); 
            margin-bottom: 8px; 
            text-align: right; 
        }
        
        .date-cell.today .date-number {
            background: var(--bleu-primary); 
            color: white; 
            border-radius: 50%;
            width: 24px; 
            height: 24px; 
            display: flex; 
            align-items: center;
            justify-content: center; 
            margin-left: auto;
        }
        
        .date-cell.other-month { 
            opacity: 0.4; 
            background-color: #F8F9FA; 
            pointer-events: none; 
        }
        
        /* 新的時段排列樣式 */
        .daily-schedules { 
            display: flex; 
            flex-direction: column;
            gap: 4px;
            width: 100%;
        }
        
        .schedule-time-group {
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: wrap;
        }
        
        .time-label {
            font-size: 10px;
            color: var(--bleu-gray-dark);
            min-width: 35px;
            font-weight: 600;
        }
        
        .employee-avatar-badge {
            width: 24px; 
            height: 24px; 
            border-radius: 50%;
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-size: 11px; 
            font-weight: 600; 
            color: white;
            transition: var(--bleu-transition); 
            border: 2px solid var(--bleu-white);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .employee-avatar-badge:hover {
            transform: scale(1.1);
            z-index: 10;
        }
        
        .more-schedules { 
            background: var(--bleu-gray); 
            color: var(--bleu-primary); 
        }

        .floating-panel {
            position: fixed; 
            top: 25px; 
            right: 25px; 
            width: 340px; 
            background: var(--bleu-white);
            border-radius: var(--bleu-radius); 
            box-shadow: var(--bleu-shadow-hover);
            z-index: 1000; 
            display: flex; 
            flex-direction: column;
            max-height: calc(100vh - 50px); 
            transform: translateX(120%); 
            opacity: 0;
            transition: transform 0.4s ease-out, opacity 0.4s ease-out;
        }
        
        .floating-panel.open { 
            transform: translateX(0); 
            opacity: 1; 
        }
        
        .panel-header {
            padding: 15px 20px; 
            border-bottom: 2px solid var(--bleu-gray-light);
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            cursor: grab;
        }
        
        .panel-title {
            color: var(--bleu-primary); 
            font-size: 18px; 
            font-weight: 600;
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        
        .panel-content { 
            padding: 20px; 
            overflow-y: auto; 
            flex: 1; 
        }
        
        .panel-section { 
            margin-bottom: 25px; 
        }
        
        .panel-section h3 {
            color: var(--bleu-primary); 
            font-size: 16px; 
            margin-bottom: 15px;
            display: flex; 
            align-items: center; 
            gap: 8px;
        }

        .sync-status {
            font-size: 12px;
            color: var(--bleu-gray-dark);
            margin-top: 10px;
        }

        .sync-status.connected {
            color: #28A745;
        }

        .item-list { 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        
        .list-item {
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 12px;
            background: var(--bleu-gray-light); 
            border-radius: 8px; 
            transition: var(--bleu-transition);
        }
        
        .list-item:hover { 
            background: var(--bleu-light); 
        }
        
        .item-details { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
        }
        
        .avatar-initial {
            width: 36px; 
            height: 36px; 
            border-radius: 50%; 
            color: white;
            display: flex; 
            align-items: center; 
            justify-content: center; 
            font-weight: 600;
        }
        
        .text-primary { 
            color: var(--bleu-primary); 
            font-weight: 600; 
        }
        
        .text-secondary { 
            color: var(--bleu-gray-dark); 
            font-size: 13px; 
        }

        .modal {
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0;
            background: rgba(0, 61, 82, 0.7); 
            backdrop-filter: blur(10px); 
            z-index: 1010; 
            padding: 20px;
        }
        
        .modal.show { 
            display: flex; 
            align-items: center; 
            justify-content: center; 
        }
        
        .modal-content {
            background: var(--bleu-white); 
            border-radius: var(--bleu-radius);
            max-width: 600px; 
            width: 100%; 
            max-height: 90vh; 
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 61, 82, 0.2);
        }
        
        .modal-header { 
            padding: 20px; 
            border-bottom: 2px solid var(--bleu-gray-light); 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .modal-body { 
            padding: 25px; 
        }
        
        .modal-footer { 
            padding: 20px; 
            background: var(--bleu-gray-light); 
            display: flex; 
            justify-content: flex-end; 
            gap: 10px; 
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: var(--bleu-primary); 
            font-size: 14px; 
        }
        
        .form-control { 
            width: 100%; 
            padding: 10px 12px; 
            border: 2px solid var(--bleu-gray); 
            border-radius: 6px; 
            font-size: 14px; 
            transition: var(--bleu-transition); 
        }
        
        .form-control:focus { 
            outline: none; 
            border-color: var(--bleu-primary); 
        }

        .time-group {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            align-items: center;
            gap: 10px;
        }

        .time-separator {
            color: var(--bleu-secondary);
            font-weight: 600;
        }

        .employee-select-list {
            border: 2px solid var(--bleu-gray);
            border-radius: 8px;
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            background: var(--bleu-gray-light);
        }

        .employee-checkbox {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 5px;
            background: var(--bleu-white);
            border-radius: 6px;
            cursor: pointer;
            transition: var(--bleu-transition);
        }

        .employee-checkbox:hover {
            background: var(--bleu-light);
        }

        .employee-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 12px;
            accent-color: var(--bleu-primary);
        }

        .employee-checkbox label {
            flex: 1;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .scheduled-list {
            margin-top: 20px;
            padding: 15px;
            background: var(--bleu-gray-light);
            border-radius: 8px;
            border: 2px solid var(--bleu-light);
        }

        .scheduled-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bleu-white);
            border-radius: 6px;
            transition: var(--bleu-transition);
        }

        .scheduled-item:hover {
            box-shadow: var(--bleu-shadow);
        }

        .quick-settings {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .preset-shift {
            padding: 10px;
            text-align: center;
            background: var(--bleu-gray-light);
            border: 2px solid var(--bleu-gray);
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: var(--bleu-transition);
            color: var(--bleu-gray-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .preset-shift:hover {
            background: var(--bleu-light);
            border-color: var(--bleu-primary);
            color: var(--bleu-primary);
        }

        .preset-shift.active {
            background: var(--bleu-primary);
            border-color: var(--bleu-primary);
            color: white;
        }

        .toast {
            position: fixed; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%) translateY(100px);
            background: var(--bleu-primary); 
            color: white; 
            padding: 14px 24px; 
            border-radius: 8px;
            opacity: 0; 
            transition: var(--bleu-transition); 
            z-index: 2000;
            box-shadow: 0 4px 20px rgba(0, 61, 82, 0.3); 
            font-weight: 500;
            display: flex; 
            align-items: center; 
            gap: 10px;
        }
        
        .toast.show { 
            opacity: 1; 
            transform: translateX(-50%) translateY(0); 
        }

        .toast.error {
            background: #DC3545;
        }

        .toast.success {
            background: #28A745;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--bleu-gray);
            border-top-color: var(--bleu-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .floating-panel { 
                width: calc(100% - 40px); 
                top: 10px; 
                right: 20px; 
                max-height: 60vh; 
            }
            .calendar-container { 
                padding: 15px; 
            }
            .calendar-grid { 
                gap: 2px; 
            }
            .calendar-cell { 
                min-height: 80px; 
            }
            .page-title h1 { 
                font-size: 22px; 
            }
            .btn { 
                padding: 8px 12px; 
                font-size: 13px; 
            }
            .time-label {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="app">
        <div class="page-title">
            <span class="material-icons">event_note</span>
            <h1>Bleu 班表系統</h1>
        </div>
        <div class="calendar-container">
            <div class="calendar-header">
                <div class="calendar-nav">
                    <button class="btn btn-icon" onclick="App.previousMonth()">
                        <span class="material-icons">chevron_left</span>
                    </button>
                    <h2 class="calendar-title" id="currentMonth"></h2>
                    <button class="btn btn-icon" onclick="App.nextMonth()">
                        <span class="material-icons">chevron_right</span>
                    </button>
                </div>
                <div class="calendar-actions">
                    <button class="btn btn-primary" onclick="App.togglePanel()">
                        <span class="material-icons-outlined">menu</span>
                        管理面板
                    </button>
                    <button class="btn btn-secondary" onclick="App.exportCSV()">
                        <span class="material-icons-outlined">download</span>
                        匯出 CSV
                    </button>
                </div>
            </div>
            <div id="calendarHeader" class="calendar-grid"></div>
            <div class="calendar-grid" id="calendarGrid"></div>
        </div>
    </div>

    <div class="floating-panel" id="floatingPanel">
        <div class="panel-header" id="panelHeader">
            <h2 class="panel-title">
                <span class="material-icons">admin_panel_settings</span>
                管理面板
            </h2>
            <button class="btn btn-icon" onclick="App.togglePanel()">
                <span class="material-icons">close</span>
            </button>
        </div>
        <div class="panel-content">
            <div class="panel-section">
                <h3><span class="material-icons-outlined">cloud_sync</span>Google Sheets 雲端同步</h3>
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-accent" onclick="App.syncToSheets()" id="uploadBtn">
                        <span class="material-icons-outlined">cloud_upload</span>
                        上傳到雲端
                    </button>
                    <button class="btn btn-primary" onclick="App.loadFromSheets()" id="downloadBtn">
                        <span class="material-icons-outlined">cloud_download</span>
                        從雲端載入
                    </button>
                </div>
                <div class="sync-status" id="syncStatus">
                    狀態：<span id="syncStatusText">未連線</span><br>
                    最後同步：<span id="lastSyncTime">無</span>
                </div>
            </div>
            <div class="panel-section">
                <h3><span class="material-icons-outlined">schedule</span>班次時段管理</h3>
                <div class="item-list" id="shiftList"></div>
                <button class="btn btn-primary" style="width: 100%; margin-top: 15px;" onclick="App.openShiftModal()">
                    <span class="material-icons">add</span>
                    新增時段
                </button>
            </div>
            <div class="panel-section">
                <h3><span class="material-icons-outlined">badge</span>員工管理</h3>
                <div class="item-list" id="employeeList"></div>
                <button class="btn btn-accent" style="width: 100%; margin-top: 15px;" onclick="App.openEmployeeModal()">
                    <span class="material-icons">person_add</span>
                    新增員工
                </button>
            </div>
        </div>
    </div>

    <!-- 員工模態框 -->
    <div class="modal" id="employeeModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>員工資料</h3>
                <button class="btn btn-icon" onclick="App.closeModal('employeeModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="employeeForm">
                    <div class="form-group">
                        <label class="form-label">姓名 *</label>
                        <input type="text" class="form-control" id="employeeName" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">頭像文字 (1-2字)</label>
                        <input type="text" class="form-control" id="employeeAvatarText" maxlength="2" placeholder="例：明、A1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">類型</label>
                        <select class="form-control" id="employeeType">
                            <option value="fulltime">正職</option>
                            <option value="parttime">兼職</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">電話</label>
                        <input type="tel" class="form-control" id="employeePhone">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-control" id="employeeEmail">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.closeModal('employeeModal')">取消</button>
                <button class="btn btn-accent" onclick="App.deleteEmployee()" id="deleteEmployeeBtn" style="display: none;">刪除</button>
                <button class="btn btn-primary" onclick="App.saveEmployee()">儲存</button>
            </div>
        </div>
    </div>

    <!-- 排班模態框 -->
    <div class="modal" id="scheduleModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="scheduleTitle">排班設定</h3>
                <button class="btn btn-icon" onclick="App.closeModal('scheduleModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="scheduleForm">
                    <div class="form-group">
                        <label class="form-label">快速選擇班次</label>
                        <div class="quick-settings" id="quickShifts"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">自訂時間</label>
                        <div class="time-group">
                            <input type="time" class="form-control" id="startTime">
                            <span class="time-separator">至</span>
                            <input type="time" class="form-control" id="endTime">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">選擇員工（可多選）</label>
                        <div class="employee-select-list" id="employeeSelectList"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">備註</label>
                        <textarea class="form-control" id="scheduleNotes" rows="2" placeholder="輸入備註..."></textarea>
                    </div>
                    <div class="scheduled-list">
                        <h4 style="margin-bottom: 10px; color: var(--bleu-primary);">當日已排班</h4>
                        <div id="currentSchedules"></div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-accent" onclick="App.clearDaySchedule()">清空當日</button>
                <button class="btn" onclick="App.closeModal('scheduleModal')">取消</button>
                <button class="btn btn-primary" onclick="App.saveSchedule()">儲存排班</button>
            </div>
        </div>
    </div>

    <!-- 時段管理模態框 -->
    <div class="modal" id="shiftModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>新增自訂時段</h3>
                <button class="btn btn-icon" onclick="App.closeModal('shiftModal')">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="shiftForm">
                    <div class="form-group">
                        <label class="form-label">時段名稱 *</label>
                        <input type="text" class="form-control" id="shiftName" placeholder="例如：大夜班">
                    </div>
                    <div class="form-group">
                        <label class="form-label">時間範圍</label>
                        <div class="time-group">
                            <input type="time" class="form-control" id="shiftStartTime">
                            <span class="time-separator">至</span>
                            <input type="time" class="form-control" id="shiftEndTime">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="App.closeModal('shiftModal')">取消</button>
                <button class="btn btn-primary" onclick="App.saveShift()">儲存時段</button>
            </div>
        </div>
    </div>

    <!-- 通知 -->
    <div class="toast" id="toast"></div>

    <script>
        const App = {
            employees: [],
            schedules: {},
            shifts: [],
            currentMonth: new Date(),
            editingEmployee: null,
            currentDate: null,
            scriptUrl: 'https://script.google.com/macros/s/AKfycbxBCtXs8OKyhEUOeHjFDFe_au1FrG3iPfMRaPLm5lEHDsCXmJIjQebzpk8OJG9--Q_3nA/exec',
            isConnected: false,
            lastSyncTime: null,

            async init() {
                this.loadData();
                this.initDefaultShifts();
                this.renderAll();
                this.setupPanelDrag();
                this.loadSyncStatus();
                window.addEventListener('storage', () => this.handleStorageChange());
            },

            handleStorageChange() {
                this.loadData();
                this.renderAll();
            },

            renderAll() {
                this.renderCalendar();
                this.renderPanel();
            },

            renderPanel() {
                this.renderEmployees();
                this.renderShifts();
            },
            
            togglePanel() { 
                document.getElementById('floatingPanel').classList.toggle('open'); 
            },
            
            setupPanelDrag() {
                const panel = document.getElementById('floatingPanel');
                const header = document.getElementById('panelHeader');
                let isDragging = false, offset = { x: 0, y: 0 };
                
                header.onmousedown = (e) => {
                    isDragging = true;
                    offset = { x: e.clientX - panel.offsetLeft, y: e.clientY - panel.offsetTop };
                    header.style.cursor = 'grabbing';
                };
                
                document.onmousemove = (e) => {
                    if (!isDragging) return;
                    let newX = e.clientX - offset.x, newY = e.clientY - offset.y;
                    const maxX = window.innerWidth - panel.offsetWidth;
                    const maxY = window.innerHeight - panel.offsetHeight;
                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));
                    panel.style.left = `${newX}px`;
                    panel.style.top = `${newY}px`;
                    panel.style.right = 'auto'; 
                    panel.style.bottom = 'auto';
                };
                
                document.onmouseup = () => { 
                    isDragging = false; 
                    header.style.cursor = 'grab'; 
                };
            },

            renderCalendar() {
                const year = this.currentMonth.getFullYear();
                const month = this.currentMonth.getMonth();
                document.getElementById('currentMonth').textContent = `${year}年 ${month + 1}月`;
                
                const calendarGrid = document.getElementById('calendarGrid');
                const calendarHeader = document.getElementById('calendarHeader');
                calendarGrid.innerHTML = '';
                calendarHeader.innerHTML = '';
                
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                calendarHeader.className = 'calendar-grid';
                
                weekdays.forEach(day => {
                    const headerCell = document.createElement('div');
                    headerCell.className = 'weekday-header';
                    headerCell.textContent = day;
                    calendarHeader.appendChild(headerCell);
                });
                
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                for (let i = 0; i < firstDay; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'calendar-cell other-month';
                    calendarGrid.appendChild(cell);
                }
                
                for (let date = 1; date <= daysInMonth; date++) {
                    const cell = this.createDateCell(year, month, date);
                    calendarGrid.appendChild(cell);
                }
                
                const totalCells = firstDay + daysInMonth;
                const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
                
                for (let i = 0; i < remainingCells; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'calendar-cell other-month';
                    calendarGrid.appendChild(cell);
                }
            },

            createDateCell(year, month, date) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell date-cell';
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const today = new Date();
                
                if (year === today.getFullYear() && month === today.getMonth() && date === today.getDate()) {
                    cell.classList.add('today');
                }
                
                const numberDiv = document.createElement('div');
                numberDiv.className = 'date-number';
                numberDiv.textContent = date;
                
                const schedulesDiv = document.createElement('div');
                schedulesDiv.className = 'daily-schedules';
                
                const daySchedules = this.schedules[dateKey] || [];
                
                if (daySchedules.length > 0) {
                    // 按時間排序並分組
                    const timeGroups = {};
                    daySchedules.forEach(schedule => {
                        const timeKey = `${schedule.startTime}-${schedule.endTime}`;
                        if (!timeGroups[timeKey]) {
                            timeGroups[timeKey] = [];
                        }
                        timeGroups[timeKey].push(schedule);
                    });
                    
                    // 排序時間段
                    const sortedTimes = Object.keys(timeGroups).sort((a, b) => {
                        const aStart = this.timeToMinutes(a.split('-')[0]);
                        const bStart = this.timeToMinutes(b.split('-')[0]);
                        return aStart - bStart;
                    });
                    
                    // 為每個時間段創建一行
                    sortedTimes.forEach(time => {
                        const timeGroup = document.createElement('div');
                        timeGroup.className = 'schedule-time-group';
                        
                        // 時間標籤
                        const timeLabel = document.createElement('span');
                        timeLabel.className = 'time-label';
                        timeLabel.textContent = time.split('-')[0];
                        timeGroup.appendChild(timeLabel);
                        
                        // 該時段的員工頭像
                        timeGroups[time].forEach(schedule => {
                            const employee = this.getEmployeeById(schedule.employeeId);
                            if (employee) {
                                const badge = this.createAvatarBadge(employee, schedule);
                                timeGroup.appendChild(badge);
                            }
                        });
                        
                        schedulesDiv.appendChild(timeGroup);
                    });
                }
                
                cell.appendChild(numberDiv);
                cell.appendChild(schedulesDiv);
                cell.onclick = () => this.openScheduleModal(date);
                return cell;
            },

            createAvatarBadge(employee, schedule) {
                const badge = document.createElement('div');
                badge.className = 'employee-avatar-badge';
                badge.textContent = employee.avatarText || employee.name.charAt(0);
                badge.style.backgroundColor = this.generateColorById(employee.id);
                badge.title = `${employee.name}\n${schedule.startTime}-${schedule.endTime}${schedule.notes ? '\n備註: ' + schedule.notes : ''}`;
                return badge;
            },

            generateColorById(id) {
                const colors = [
                    "#e53935", "#d81b60", "#8e24aa", "#5e35b1", "#3949ab", 
                    "#1e88e5", "#039be5", "#00acc1", "#00897b", "#43a047", 
                    "#7cb342", "#c0ca33", "#fdd835", "#ffb300", "#fb8c00", 
                    "#f4511e", "#6d4c41", "#757575", "#546e7a"
                ];
                return colors[id % colors.length];
            },

            renderEmployees() {
                const list = document.getElementById('employeeList');
                list.innerHTML = '';
                
                if (this.employees.length === 0) { 
                    list.innerHTML = `<div style="text-align: center; color: var(--bleu-gray-dark); padding: 20px;">尚無員工</div>`; 
                    return; 
                }
                
                this.employees.forEach(employee => {
                    const item = document.createElement('div');
                    item.className = 'list-item employee-item';
                    item.innerHTML = `
                        <div class="item-details">
                            <div class="avatar-initial" style="background-color: ${this.generateColorById(employee.id)}">
                                ${employee.avatarText || employee.name.charAt(0)}
                            </div>
                            <div>
                                <div class="text-primary">${employee.name}</div>
                                <div class="text-secondary">${employee.type === 'fulltime' ? '正職' : '兼職'}</div>
                            </div>
                        </div>
                        <button class="btn btn-icon" onclick="event.stopPropagation(); App.openEmployeeModal(${employee.id})">
                            <span class="material-icons">edit</span>
                        </button>`;
                    item.onclick = () => this.openEmployeeModal(employee.id);
                    list.appendChild(item);
                });
            },

            renderShifts() {
                const list = document.getElementById('shiftList');
                list.innerHTML = '';
                
                this.shifts.forEach(shift => {
                    const item = document.createElement('div');
                    item.className = 'list-item shift-item';
                    item.innerHTML = `
                        <div class="item-details">
                            <div>
                                <div class="text-primary">${shift.name}</div>
                                <div class="text-secondary">${shift.startTime} - ${shift.endTime}</div>
                            </div>
                        </div>
                        ${shift.id > 3 ? `<button class="btn btn-icon" onclick="App.deleteShift(${shift.id})">
                            <span class="material-icons">delete</span>
                        </button>` : ''}
                    `;
                    list.appendChild(item);
                });
            },

            openEmployeeModal(employeeId = null) {
                const isNew = employeeId === null;
                this.editingEmployee = isNew ? null : this.getEmployeeById(employeeId);
                const modal = document.getElementById('employeeModal');
                
                modal.querySelector('#employeeName').value = isNew ? '' : this.editingEmployee.name;
                modal.querySelector('#employeeAvatarText').value = isNew ? '' : (this.editingEmployee.avatarText || '');
                modal.querySelector('#employeeType').value = isNew ? 'fulltime' : this.editingEmployee.type;
                modal.querySelector('#employeePhone').value = isNew ? '' : (this.editingEmployee.phone || '');
                modal.querySelector('#employeeEmail').value = isNew ? '' : (this.editingEmployee.email || '');
                modal.querySelector('#deleteEmployeeBtn').style.display = isNew ? 'none' : 'inline-flex';
                modal.classList.add('show');
            },

            saveEmployee() {
                const name = document.getElementById('employeeName').value.trim();
                const avatarText = document.getElementById('employeeAvatarText').value.trim();
                
                if (!name) {
                    this.showToast('請輸入員工姓名', 'error');
                    return;
                }
                
                const employeeData = { 
                    name, 
                    avatarText, 
                    type: document.getElementById('employeeType').value,
                    phone: document.getElementById('employeePhone').value.trim(),
                    email: document.getElementById('employeeEmail').value.trim()
                };

                if (this.editingEmployee) {
                    Object.assign(this.editingEmployee, employeeData);
                    this.showToast('員工資料已更新', 'success');
                } else {
                    employeeData.id = Date.now();
                    this.employees.push(employeeData);
                    this.showToast('新員工已新增', 'success');
                }

                this.saveData();
                this.renderAll();
                this.closeModal('employeeModal');
            },
            
            deleteEmployee() {
                if (!this.editingEmployee || !confirm(`確定刪除員工 ${this.editingEmployee.name} 嗎？相關排班也會被移除。`)) return;
                
                const employeeId = this.editingEmployee.id;
                this.employees = this.employees.filter(e => e.id !== employeeId);
                
                Object.keys(this.schedules).forEach(date => {
                    this.schedules[date] = this.schedules[date].filter(s => s.employeeId !== employeeId);
                    if (this.schedules[date].length === 0) delete this.schedules[date];
                });
                
                this.saveData();
                this.renderAll();
                this.closeModal('employeeModal');
                this.showToast('員工已刪除', 'success');
            },

            openScheduleModal(date) {
                const year = this.currentMonth.getFullYear();
                const month = this.currentMonth.getMonth();
                this.currentDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                
                document.getElementById('scheduleTitle').textContent = `${year}年${month + 1}月${date}日 排班設定`;
                
                // 渲染快速選擇
                const quickShifts = document.getElementById('quickShifts');
                quickShifts.innerHTML = '';
                this.shifts.forEach(shift => {
                    const btn = document.createElement('div');
                    btn.className = 'preset-shift';
                    btn.textContent = shift.name;
                    btn.onclick = () => {
                        document.querySelectorAll('.preset-shift').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        document.getElementById('startTime').value = shift.startTime;
                        document.getElementById('endTime').value = shift.endTime;
                    };
                    quickShifts.appendChild(btn);
                });
                
                // 渲染員工選擇
                const employeeSelectList = document.getElementById('employeeSelectList');
                employeeSelectList.innerHTML = '';
                
                this.employees.forEach(emp => {
                    const div = document.createElement('div');
                    div.className = 'employee-checkbox';
                    div.innerHTML = `
                        <input type="checkbox" id="emp_${emp.id}" value="${emp.id}">
                        <label for="emp_${emp.id}">
                            <span>${emp.name}</span>
                            <span style="font-size: 12px; color: var(--bleu-secondary);">
                                ${emp.type === 'fulltime' ? '正職' : 'PT'}
                            </span>
                        </label>
                    `;
                    employeeSelectList.appendChild(div);
                });
                
                this.loadCurrentSchedules();
                
                document.getElementById('startTime').value = '';
                document.getElementById('endTime').value = '';
                document.getElementById('scheduleNotes').value = '';
                
                document.getElementById('scheduleModal').classList.add('show');
            },

            loadCurrentSchedules() {
                const currentSchedules = document.getElementById('currentSchedules');
                currentSchedules.innerHTML = '';
                
                const schedules = this.schedules[this.currentDate] || [];
                
                if (schedules.length === 0) {
                    currentSchedules.innerHTML = '<div style="text-align: center; color: var(--bleu-gray-dark);">尚無排班</div>';
                    return;
                }
                
                // 按時間排序
                const sortedSchedules = [...schedules].sort((a, b) => {
                    return this.timeToMinutes(a.startTime) - this.timeToMinutes(b.startTime);
                });
                
                sortedSchedules.forEach((schedule, index) => {
                    const div = document.createElement('div');
                    div.className = 'scheduled-item';
                    div.innerHTML = `
                        <div class="scheduled-info">
                            <span class="scheduled-name">${this.getEmployeeName(schedule.employeeId)}</span>
                            <span class="scheduled-time">${schedule.startTime} - ${schedule.endTime}</span>
                        </div>
                        <button class="btn btn-icon" onclick="App.removeSchedule(${schedules.indexOf(schedule)})">
                            <span class="material-icons">remove</span>
                        </button>
                    `;
                    currentSchedules.appendChild(div);
                });
            },

            saveSchedule() {
                const startTime = document.getElementById('startTime').value;
                const endTime = document.getElementById('endTime').value;
                const notes = document.getElementById('scheduleNotes').value.trim();
                
                const selectedEmployees = [];
                document.querySelectorAll('.employee-checkbox input:checked').forEach(checkbox => {
                    selectedEmployees.push(parseInt(checkbox.value));
                });
                
                if (selectedEmployees.length === 0) {
                    this.showToast('請選擇至少一位員工', 'error');
                    return;
                }
                
                if (!startTime || !endTime) {
                    this.showToast('請設定時間', 'error');
                    return;
                }
                
                if (!this.schedules[this.currentDate]) {
                    this.schedules[this.currentDate] = [];
                }
                
                selectedEmployees.forEach(employeeId => {
                    const hasConflict = this.schedules[this.currentDate].some(s => 
                        s.employeeId === employeeId && 
                        this.isTimeOverlap(s.startTime, s.endTime, startTime, endTime)
                    );
                    
                    if (!hasConflict) {
                        this.schedules[this.currentDate].push({
                            employeeId,
                            startTime,
                            endTime,
                            notes
                        });
                    } else {
                        const employee = this.getEmployeeById(employeeId);
                        this.showToast(`${employee.name} 在該時段已有排班`, 'error');
                    }
                });
                
                this.saveData();
                this.renderCalendar();
                this.loadCurrentSchedules();
                this.showToast('排班已儲存', 'success');
                
                document.querySelectorAll('.employee-checkbox input:checked').forEach(checkbox => {
                    checkbox.checked = false;
                });
            },

            removeSchedule(index) {
                if (this.schedules[this.currentDate]) {
                    this.schedules[this.currentDate].splice(index, 1);
                    if (this.schedules[this.currentDate].length === 0) {
                        delete this.schedules[this.currentDate];
                    }
                    this.saveData();
                    this.loadCurrentSchedules();
                    this.renderCalendar();
                    this.showToast('已移除排班', 'success');
                }
            },

            clearDaySchedule() {
                if (confirm('確定要清空當日所有排班嗎？')) {
                    delete this.schedules[this.currentDate];
                    this.saveData();
                    this.loadCurrentSchedules();
                    this.renderCalendar();
                    this.showToast('已清空當日排班', 'success');
                }
            },

            openShiftModal() {
                document.getElementById('shiftForm').reset();
                document.getElementById('shiftModal').classList.add('show');
            },

            saveShift() {
                const name = document.getElementById('shiftName').value.trim();
                const startTime = document.getElementById('shiftStartTime').value;
                const endTime = document.getElementById('shiftEndTime').value;
                
                if (!name || !startTime || !endTime) {
                    this.showToast('請填寫完整資料', 'error');
                    return;
                }
                
                const newShift = {
                    id: Date.now(),
                    name,
                    startTime,
                    endTime
                };
                
                this.shifts.push(newShift);
                this.saveData();
                this.renderShifts();
                this.closeModal('shiftModal');
                this.showToast('時段已新增', 'success');
            },

            deleteShift(id) {
                if (confirm('確定要刪除這個時段嗎？')) {
                    this.shifts = this.shifts.filter(s => s.id !== id);
                    this.saveData();
                    this.renderShifts();
                    this.showToast('時段已刪除', 'success');
                }
            },

            isTimeOverlap(start1, end1, start2, end2) {
                const s1 = this.timeToMinutes(start1);
                const e1 = this.timeToMinutes(end1);
                const s2 = this.timeToMinutes(start2);
                const e2 = this.timeToMinutes(end2);
                
                let e1Adjusted = e1 < s1 ? e1 + 1440 : e1;
                let e2Adjusted = e2 < s2 ? e2 + 1440 : e2;
                
                return (s1 < e2Adjusted && s2 < e1Adjusted);
            },

            timeToMinutes(time) {
                const [hours, minutes] = time.split(':').map(Number);
                return hours * 60 + minutes;
            },

            getEmployeeById(id) { 
                return this.employees.find(e => e.id === id); 
            },

            getEmployeeName(id) {
                const emp = this.getEmployeeById(id);
                return emp ? emp.name : '未知';
            },

            closeModal(id) { 
                document.getElementById(id).classList.remove('show'); 
            },
            
            previousMonth() { 
                this.currentMonth.setMonth(this.currentMonth.getMonth() - 1); 
                this.renderCalendar(); 
            },
            
            nextMonth() { 
                this.currentMonth.setMonth(this.currentMonth.getMonth() + 1); 
                this.renderCalendar(); 
            },

            exportCSV() {
                const year = this.currentMonth.getFullYear();
                const month = this.currentMonth.getMonth() + 1;
                
                let csv = '\ufeff'; // BOM for UTF-8
                csv += '日期,星期,時間,員工,類型,備註\n';
                
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                
                Object.keys(this.schedules).forEach(date => {
                    if (date.startsWith(`${year}-${String(month).padStart(2, '0')}`)) {
                        const dateObj = new Date(date + 'T00:00:00');
                        const weekday = weekdays[dateObj.getDay()];
                        
                        this.schedules[date].forEach(schedule => {
                            const employee = this.employees.find(e => e.id === schedule.employeeId);
                            csv += `${date},週${weekday},${schedule.startTime}-${schedule.endTime},${employee.name},${employee.type === 'fulltime' ? '正職' : 'PT'},${schedule.notes || ''}\n`;
                        });
                    }
                });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `排班表_${year}年${month}月.csv`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showToast('CSV 檔案已匯出', 'success');
            },

            async syncToSheets() {
                const uploadBtn = document.getElementById('uploadBtn');
                const originalHTML = uploadBtn.innerHTML;
                uploadBtn.innerHTML = '<span class="loading"></span> 上傳中...';
                uploadBtn.disabled = true;
                
                try {
                    const sheetData = this.prepareSheetData();
                    
                    const response = await fetch(this.scriptUrl, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: {
                            'Content-Type': 'text/plain;charset=utf-8',
                        },
                        body: JSON.stringify({
                            data: sheetData,
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    this.updateSyncStatus(true);
                    this.showToast('資料已成功上傳到 Google Sheets！', 'success');
                    
                } catch (error) {
                    console.error('上傳錯誤:', error);
                    this.updateSyncStatus(false);
                    this.showToast('上傳失敗，請檢查網路連線', 'error');
                } finally {
                    uploadBtn.innerHTML = originalHTML;
                    uploadBtn.disabled = false;
                }
            },

            async loadFromSheets() {
                const downloadBtn = document.getElementById('downloadBtn');
                const originalHTML = downloadBtn.innerHTML;
                downloadBtn.innerHTML = '<span class="loading"></span> 載入中...';
                downloadBtn.disabled = true;
                
                try {
                    const response = await fetch(this.scriptUrl + '?sheet=data');
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        this.parseSheetData(result.data);
                        this.saveData();
                        this.renderAll();
                        this.updateSyncStatus(true);
                        this.showToast('已從 Google Sheets 載入資料！', 'success');
                    } else {
                        throw new Error('資料格式錯誤');
                    }
                    
                } catch (error) {
                    console.error('載入失敗:', error);
                    this.updateSyncStatus(false);
                    this.showToast('載入失敗，請確認試算表內容', 'error');
                } finally {
                    downloadBtn.innerHTML = originalHTML;
                    downloadBtn.disabled = false;
                }
            },

            prepareSheetData() {
                const data = [];
                
                data.push(['Bleu 班表系統資料']);
                data.push(['匯出時間', new Date().toLocaleString('zh-TW')]);
                data.push([]);
                
                data.push(['=== 員工資料 ===']);
                data.push(['ID', '姓名', '頭像文字', '類型', '電話', 'Email']);
                this.employees.forEach(emp => {
                    data.push([
                        emp.id,
                        emp.name,
                        emp.avatarText || '',
                        emp.type === 'fulltime' ? '正職' : 'PT',
                        emp.phone || '',
                        emp.email || ''
                    ]);
                });
                
                data.push([]);
                
                data.push(['=== 班次設定 ===']);
                data.push(['ID', '名稱', '開始時間', '結束時間']);
                this.shifts.forEach(shift => {
                    data.push([
                        shift.id,
                        shift.name,
                        shift.startTime,
                        shift.endTime
                    ]);
                });
                
                data.push([]);
                
                data.push(['=== 排班資料 ===']);
                data.push(['日期', '員工ID', '員工姓名', '開始時間', '結束時間', '備註']);
                
                const sortedDates = Object.keys(this.schedules).sort();
                sortedDates.forEach(date => {
                    // 按時間排序每天的排班
                    const sortedSchedules = [...this.schedules[date]].sort((a, b) => {
                        return this.timeToMinutes(a.startTime) - this.timeToMinutes(b.startTime);
                    });
                    
                    sortedSchedules.forEach(schedule => {
                        const employee = this.employees.find(e => e.id === schedule.employeeId);
                        data.push([
                            date,
                            schedule.employeeId,
                            employee ? employee.name : '未知',
                            schedule.startTime,
                            schedule.endTime,
                            schedule.notes || ''
                        ]);
                    });
                });
                
                return data;
            },

            parseSheetData(data) {
                this.employees = [];
                this.shifts = [];
                this.schedules = {};
                
                let section = '';
                for (let i = 0; i < data.length; i++) {
                    const row = data[i];
                    if (!row || row.length === 0) continue;
                    
                    if (row[0] === '=== 員工資料 ===') {
                        section = 'employees';
                        i++;
                        continue;
                    } else if (row[0] === '=== 班次設定 ===') {
                        section = 'shifts';
                        i++;
                        continue;
                    } else if (row[0] === '=== 排班資料 ===') {
                        section = 'schedules';
                        i++;
                        continue;
                    }
                    
                    if (section === 'employees' && row[0] && row[0] !== 'ID') {
                        this.employees.push({
                            id: parseInt(row[0]) || Date.now() + Math.random(),
                            name: row[1],
                            avatarText: row[2] || '',
                            type: row[3] === '正職' ? 'fulltime' : 'parttime',
                            phone: row[4] || '',
                            email: row[5] || ''
                        });
                    } else if (section === 'shifts' && row[0] && row[0] !== 'ID') {
                        this.shifts.push({
                            id: parseInt(row[0]) || Date.now() + Math.random(),
                            name: row[1],
                            startTime: row[2],
                            endTime: row[3]
                        });
                    } else if (section === 'schedules' && row[0] && row[0] !== '日期') {
                        const date = row[0];
                        if (!this.schedules[date]) {
                            this.schedules[date] = [];
                        }
                        
                        this.schedules[date].push({
                            employeeId: parseInt(row[1]),
                            startTime: row[3],
                            endTime: row[4],
                            notes: row[5] || ''
                        });
                    }
                }
                
                if (this.shifts.length === 0) {
                    this.initDefaultShifts();
                }
            },

            updateSyncStatus(connected) {
                this.isConnected = connected;
                const statusEl = document.getElementById('syncStatus');
                const statusText = document.getElementById('syncStatusText');
                const lastSyncEl = document.getElementById('lastSyncTime');
                
                if (connected) {
                    statusEl.classList.add('connected');
                    statusText.textContent = '已連線';
                    this.lastSyncTime = new Date();
                    lastSyncEl.textContent = this.lastSyncTime.toLocaleString('zh-TW');
                    localStorage.setItem('lastSync', this.lastSyncTime.toISOString());
                } else {
                    statusEl.classList.remove('connected');
                    statusText.textContent = '未連線';
                }
            },

            loadSyncStatus() {
                const lastSync = localStorage.getItem('lastSync');
                if (lastSync) {
                    this.lastSyncTime = new Date(lastSync);
                    document.getElementById('lastSyncTime').textContent = this.lastSyncTime.toLocaleString('zh-TW');
                }
            },

            loadData() {
                const data = JSON.parse(localStorage.getItem('bleuScheduleData') || '{}');
                this.employees = data.employees || [];
                this.schedules = data.schedules || {};
                this.shifts = data.shifts || [];
                
                // 如果沒有資料，建立預設資料
                if (this.employees.length === 0) {
                    this.employees = [
                        { 
                            id: 1, 
                            name: '王小明', 
                            avatarText: '明',
                            type: 'fulltime', 
                            phone: '0912345678', 
                            email: 'ming@example.com' 
                        },
                        { 
                            id: 2, 
                            name: '李小華', 
                            avatarText: '華',
                            type: 'fulltime', 
                            phone: '0923456789', 
                            email: 'hua@example.com' 
                        },
                        { 
                            id: 3, 
                            name: '張大偉', 
                            avatarText: 'W',
                            type: 'parttime', 
                            phone: '0934567890', 
                            email: 'wei@example.com' 
                        }
                    ];
                    this.saveData();
                }
            },

            saveData() {
                const data = { 
                    employees: this.employees, 
                    schedules: this.schedules, 
                    shifts: this.shifts, 
                    lastUpdated: new Date().toISOString() 
                };
                localStorage.setItem('bleuScheduleData', JSON.stringify(data));
            },
            
            initDefaultShifts() {
                if (this.shifts.length === 0) {
                    this.shifts = [
                        { id: 1, name: '早班', startTime: '08:00', endTime: '16:00' },
                        { id: 2, name: '午班', startTime: '16:00', endTime: '00:00' },
                        { id: 3, name: '晚班', startTime: '00:00', endTime: '08:00' }
                    ];
                    this.saveData();
                }
            },

            showToast(message, type = 'success') {
                const toast = document.getElementById('toast');
                
                let icon = 'info';
                if (type === 'success') icon = 'check_circle';
                if (type === 'error') icon = 'error';
                if (type === 'warning') icon = 'warning';
                
                toast.innerHTML = `
                    <span class="material-icons">${icon}</span>
                    ${message}
                `;
                
                toast.className = 'toast show';
                
                if (type === 'error') {
                    toast.classList.add('error');
                } else if (type === 'success') {
                    toast.classList.add('success');
                } else if (type === 'warning') {
                    toast.classList.add('warning');
                }
                
                clearTimeout(this.toastTimeout);
                this.toastTimeout = setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        };

        // 啟動應用程式
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });

        // ESC 鍵關閉模態框
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                document.querySelectorAll('.modal.show').forEach(modal => {
                    modal.classList.remove('show');
                });
            }
        });

        // 點擊模態框外部關閉
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
        });

        // 防止拖曳面板時選取文字
        document.getElementById('panelHeader').addEventListener('selectstart', (e) => {
            e.preventDefault();
        });
    </script>
</body>
</html>
