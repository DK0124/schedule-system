<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bleu 班表總覽 - 管理者檢視</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary: #E97132;
            --primary-dark: #d05520;
            --primary-light: #FFE5D9;
            --secondary: #2C3E50;
            --success: #27AE60;
            --warning: #F39C12;
            --danger: #E74C3C;
            --dark: #34495E;
            --light: #ECF0F1;
            --white: #FFFFFF;
            --gray: #95A5A6;
            --border: #BDC3C7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background: linear-gradient(135deg, var(--primary-light) 0%, #fff5f0 100%);
            color: var(--dark);
            min-height: 100vh;
            padding: 20px;
        }

        /* 頁首 */
        .header {
            background: white;
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 20px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
            min-width: 200px;
        }

        .logo-icon {
            width: 50px;
            height: 50px;
            background: var(--primary);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            font-weight: bold;
        }

        .logo-text h1 {
            color: var(--primary);
            font-size: 28px;
            margin-bottom: 2px;
        }

        .logo-text p {
            color: var(--gray);
            font-size: 14px;
        }

        /* 日期控制 */
        .date-controls {
            display: flex;
            align-items: center;
            gap: 15px;
            background: var(--light);
            padding: 10px 15px;
            border-radius: 12px;
        }

        .date-btn {
            background: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .date-btn:hover {
            background: var(--primary);
            color: white;
            transform: scale(1.1);
        }

        .current-date {
            font-size: 18px;
            font-weight: 500;
            min-width: 140px;
            text-align: center;
        }

        /* 檢視模式切換 */
        .view-modes {
            display: flex;
            gap: 10px;
            background: var(--light);
            padding: 5px;
            border-radius: 12px;
        }

        .view-mode-btn {
            padding: 10px 20px;
            border: none;
            background: transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .view-mode-btn.active {
            background: var(--primary);
            color: white;
        }

        /* 同步狀態 */
        .sync-status {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-left: auto;
        }

        #syncStatus {
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* 統計卡片 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .stat-icon.primary {
            background: var(--primary-light);
            color: var(--primary);
        }

        .stat-icon.success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }

        .stat-icon.warning {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }

        .stat-icon.info {
            background: rgba(52, 152, 219, 0.1);
            color: #3498DB;
        }

        .stat-info h3 {
            font-size: 24px;
            color: var(--dark);
            margin-bottom: 5px;
        }

        .stat-info p {
            color: var(--gray);
            font-size: 14px;
        }

        /* 主要內容區 */
        .main-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* 頁籤 */
        .tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--light);
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 16px;
            position: relative;
            transition: all 0.3s;
        }

        .tab:hover {
            color: var(--primary);
        }

        .tab.active {
            color: var(--primary);
            font-weight: 500;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            border-radius: 3px 3px 0 0;
        }

        /* 週檢視 */
        .week-view {
            overflow-x: auto;
        }

        .week-grid {
            display: grid;
            grid-template-columns: 150px repeat(7, 1fr);
            min-width: 900px;
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .week-header {
            background: var(--light);
            padding: 15px;
            font-weight: 500;
            text-align: center;
        }

        .week-header.employee-col {
            background: var(--secondary);
            color: white;
        }

        .week-header.today {
            background: var(--primary);
            color: white;
        }

        .employee-row {
            display: contents;
        }

        .employee-cell {
            background: white;
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 500;
        }

        .employee-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .shift-cell {
            background: white;
            padding: 10px;
            min-height: 80px;
            position: relative;
        }

        .shift-cell.today {
            background: var(--primary-light);
        }

        .shift-badge {
            background: var(--primary);
            color: white;
            padding: 5px 10px;
            border-radius: 6px;
            font-size: 13px;
            display: inline-block;
            margin-bottom: 5px;
        }

        .shift-time {
            font-size: 12px;
            color: var(--gray);
        }

        .no-shift {
            color: var(--gray);
            text-align: center;
            padding: 20px;
            font-size: 14px;
        }

        /* 月檢視 */
        .month-view {
            overflow-x: auto;
        }

        .month-calendar {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 1px;
            background: var(--border);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .calendar-header {
            background: var(--secondary);
            color: white;
            padding: 15px;
            text-align: center;
            font-weight: 500;
        }

        .calendar-day {
            background: white;
            min-height: 120px;
            padding: 10px;
            position: relative;
        }

        .calendar-day.other-month {
            background: var(--light);
            opacity: 0.5;
        }

        .calendar-day.today {
            background: var(--primary-light);
        }

        .day-number {
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--dark);
        }

        .day-schedules {
            font-size: 12px;
        }

        .schedule-item {
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* 清單檢視 */
        .list-view {
            overflow-x: auto;
        }

        .schedule-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }

        .schedule-table th {
            background: var(--secondary);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 500;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .schedule-table td {
            padding: 15px;
            border-bottom: 1px solid var(--light);
        }

        .schedule-table tr:hover {
            background: var(--light);
        }

        /* 篩選區 */
        .filters {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filter-group label {
            color: var(--gray);
            font-size: 14px;
        }

        .filter-select {
            padding: 8px 15px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: white;
            cursor: pointer;
            min-width: 150px;
        }

        /* 匯出按鈕 */
        .export-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }

        .export-btn {
            padding: 10px 20px;
            border: 1px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }

        .export-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* 載入動畫 */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid var(--light);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Toast 動畫 */
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }
        
        .toast {
            transition: all 0.3s ease;
        }
        
        .toast:hover {
            transform: scale(1.02);
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .header {
                padding: 20px;
            }

            .logo-text h1 {
                font-size: 24px;
            }

            .stats-container {
                grid-template-columns: 1fr;
            }

            .filters {
                flex-direction: column;
            }

            .export-buttons {
                width: 100%;
                margin-left: 0;
            }

            .export-btn {
                flex: 1;
            }

            .week-grid {
                font-size: 14px;
            }

            .tabs {
                overflow-x: auto;
            }

            .sync-status {
                margin-left: 0;
                width: 100%;
            }
        }

        /* 列印樣式 */
        @media print {
            body {
                background: white;
                padding: 0;
            }

            .header {
                box-shadow: none;
                border: 1px solid var(--border);
            }

            .date-controls,
            .view-modes,
            .export-buttons,
            .sync-status {
                display: none;
            }

            .main-container {
                box-shadow: none;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- 載入動畫 -->
    <div class="loading" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- 頁首 -->
    <div class="header">
        <div class="logo">
            <div class="logo-icon">B</div>
            <div class="logo-text">
                <h1>Bleu Cafe</h1>
                <p>班表管理系統 - 總覽</p>
            </div>
        </div>

        <div class="date-controls">
            <button class="date-btn" onclick="App.previousPeriod()">
                <span class="material-icons">chevron_left</span>
            </button>
            <div class="current-date" id="currentPeriod">2025年11月</div>
            <button class="date-btn" onclick="App.nextPeriod()">
                <span class="material-icons">chevron_right</span>
            </button>
            <button class="date-btn" onclick="App.goToToday()">
                <span class="material-icons">today</span>
            </button>
        </div>

        <div class="view-modes">
            <button class="view-mode-btn active" onclick="App.setViewMode('week')">
                <span class="material-icons">view_week</span>
                週檢視
            </button>
            <button class="view-mode-btn" onclick="App.setViewMode('month')">
                <span class="material-icons">calendar_month</span>
                月檢視
            </button>
            <button class="view-mode-btn" onclick="App.setViewMode('list')">
                <span class="material-icons">list</span>
                清單
            </button>
        </div>

        <div class="sync-status">
            <div id="syncStatus">
                <span style="color: var(--gray);">● 連線中...</span>
            </div>
            <button class="date-btn" onclick="App.refresh()" title="重新整理 (Ctrl+R)">
                <span class="material-icons">refresh</span>
            </button>
        </div>
    </div>

    <!-- 統計卡片 -->
    <div class="stats-container">
        <div class="stat-card">
            <div class="stat-icon primary">
                <span class="material-icons">people</span>
            </div>
            <div class="stat-info">
                <h3 id="totalEmployees">0</h3>
                <p>總員工數</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon success">
                <span class="material-icons">schedule</span>
            </div>
            <div class="stat-info">
                <h3 id="todayWorking">0</h3>
                <p>今日上班人數</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon warning">
                <span class="material-icons">access_time</span>
            </div>
            <div class="stat-info">
                <h3 id="totalHours">0</h3>
                <p>本月總工時</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon info">
                <span class="material-icons">trending_up</span>
            </div>
            <div class="stat-info">
                <h3 id="avgHours">0</h3>
                <p>平均每日工時</p>
            </div>
        </div>
    </div>

    <!-- 主要內容 -->
    <div class="main-container">
        <!-- 篩選區 -->
        <div class="filters">
            <div class="filter-group">
                <label>員工類型：</label>
                <select class="filter-select" id="typeFilter" onchange="App.applyFilters()">
                    <option value="all">全部</option>
                    <option value="fulltime">正職</option>
                    <option value="parttime">兼職</option>
                </select>
            </div>

            <div class="filter-group">
                <label>班次：</label>
                <select class="filter-select" id="shiftFilter" onchange="App.applyFilters()">
                    <option value="all">全部班次</option>
                </select>
            </div>

            <div class="export-buttons">
                <button class="export-btn" onclick="App.exportExcel()">
                    <span class="material-icons">file_download</span>
                    匯出 Excel
                </button>
                <button class="export-btn" onclick="App.print()">
                    <span class="material-icons">print</span>
                    列印
                </button>
            </div>
        </div>

        <!-- 頁籤 -->
        <div class="tabs">
            <button class="tab active" onclick="App.setTab('overview')">總覽</button>
            <button class="tab" onclick="App.setTab('statistics')">統計分析</button>
            <button class="tab" onclick="App.setTab('comparison')">員工比較</button>
        </div>

        <!-- 內容區 -->
        <div id="contentArea">
            <!-- 動態內容將插入這裡 -->
        </div>
    </div>

    <script>
        const App = {
            // GAS 設定
            scriptUrl: 'https://script.google.com/macros/s/AKfycbzDImzTB17fp5FViVwXtIzxUrH-ByJ4p2lRrk__YPG-DJctKsE2YRZ3CqXlrHkZeZbW3A/exec',
            
            // 資料
            employees: [],
            shifts: [],
            schedules: {},
            
            // 狀態
            currentView: 'week',
            currentTab: 'overview',
            currentDate: new Date(),
            filters: {
                type: 'all',
                shift: 'all'
            },
            syncEnabled: false,
            lastSyncTime: null,

            // 初始化
            async init() {
                console.log('Boss Overview 初始化...');
                this.showLoading();
                
                // 先嘗試從 localStorage 載入資料
                this.loadLocalData();
                
                // 然後從 GAS 載入最新資料
                await this.loadFromCloud();
                
                this.setupEventListeners();
                this.updateDisplay();
                this.hideLoading();
                
                // 設定自動同步
                this.startAutoSync();
            },

            // 從 localStorage 載入資料
            loadLocalData() {
                const savedEmployees = localStorage.getItem('employees');
                const savedShifts = localStorage.getItem('shifts');
                const savedSchedules = localStorage.getItem('schedules');

                if (savedEmployees) {
                    this.employees = JSON.parse(savedEmployees);
                }

                if (savedShifts) {
                    this.shifts = JSON.parse(savedShifts);
                    this.updateShiftFilter();
                }

                if (savedSchedules) {
                    this.schedules = JSON.parse(savedSchedules);
                }

                this.updateStatistics();
            },

            // 從 Google Sheets 載入資料
            async loadFromCloud() {
                try {
                    console.log('從 Google Sheets 載入資料...');
                    
                    const response = await fetch(`${this.scriptUrl}?action=getRealtimeData`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        console.log('成功載入雲端資料:', result.data);
                        
                        // 更新本地資料
                        this.employees = result.data.employees || [];
                        this.shifts = result.data.shifts || [];
                        this.schedules = result.data.schedules || {};
                        
                        // 儲存到 localStorage
                        localStorage.setItem('employees', JSON.stringify(this.employees));
                        localStorage.setItem('shifts', JSON.stringify(this.shifts));
                        localStorage.setItem('schedules', JSON.stringify(this.schedules));
                        
                        // 更新顯示
                        this.updateShiftFilter();
                        this.updateStatistics();
                        this.updateDisplay();
                        
                        // 更新同步狀態
                        this.lastSyncTime = new Date();
                        this.updateSyncStatus(true);
                        
                        this.showToast('資料同步成功', 'success');
                        
                        return true;
                    } else {
                        throw new Error(result.error || '無法載入資料');
                    }
                } catch (error) {
                    console.error('載入雲端資料失敗:', error);
                    this.showToast('無法連接到雲端資料，使用本地快取', 'warning');
                    this.updateSyncStatus(false);
                    return false;
                }
            },

            // 開始自動同步
            startAutoSync() {
                // 每 30 秒自動同步一次
                setInterval(async () => {
                    if (this.syncEnabled) {
                        await this.loadFromCloud();
                    }
                }, 30000);
                
                // 預設啟用自動同步
                this.syncEnabled = true;
            },

            // 手動重新整理
            async refresh() {
                this.showLoading();
                const success = await this.loadFromCloud();
                this.hideLoading();
                
                if (success) {
                    this.updateDisplay();
                }
            },

            // 更新同步狀態顯示
            updateSyncStatus(isConnected) {
                const statusHtml = isConnected 
                    ? '<span style="color: var(--success);">● 已連線</span>'
                    : '<span style="color: var(--danger);">● 離線</span>';
                
                document.getElementById('syncStatus').innerHTML = statusHtml;
            },

            // 顯示載入動畫
            showLoading() {
                document.getElementById('loading').style.display = 'flex';
            },

            // 隱藏載入動畫
            hideLoading() {
                document.getElementById('loading').style.display = 'none';
            },

            // 顯示提示訊息
            showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.textContent = message;
                toast.style.cssText = `
                    position: fixed;
                    bottom: 20px;
                    right: 20px;
                    padding: 15px 20px;
                    background: ${type === 'success' ? 'var(--success)' : type === 'warning' ? 'var(--warning)' : 'var(--primary)'};
                    color: white;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 9999;
                    animation: slideIn 0.3s ease;
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.style.animation = 'slideOut 0.3s ease';
                    setTimeout(() => toast.remove(), 300);
                }, 3000);
            },

            // 設定事件監聽
            setupEventListeners() {
                // 鍵盤快捷鍵
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'ArrowLeft' && !e.shiftKey) {
                        this.previousPeriod();
                    } else if (e.key === 'ArrowRight' && !e.shiftKey) {
                        this.nextPeriod();
                    } else if (e.key === 'Escape') {
                        this.goToToday();
                    } else if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                        e.preventDefault();
                        this.refresh();
                    }
                });

                // 視窗焦點事件
                window.addEventListener('focus', () => {
                    if (this.syncEnabled) {
                        this.loadFromCloud();
                    }
                });

                // 線上/離線事件
                window.addEventListener('online', () => {
                    this.showToast('網路已連接', 'success');
                    this.loadFromCloud();
                });

                window.addEventListener('offline', () => {
                    this.showToast('網路已斷開', 'warning');
                    this.updateSyncStatus(false);
                });
            },

            // 更新顯示
            updateDisplay() {
                const periodEl = document.getElementById('currentPeriod');
                
                if (this.currentView === 'week') {
                    const weekStart = this.getWeekStart(this.currentDate);
                    const weekEnd = new Date(weekStart);
                    weekEnd.setDate(weekEnd.getDate() + 6);
                    
                    periodEl.textContent = `${this.formatDate(weekStart)} - ${this.formatDate(weekEnd)}`;
                    this.renderWeekView();
                } else if (this.currentView === 'month') {
                    const year = this.currentDate.getFullYear();
                    const month = this.currentDate.getMonth() + 1;
                    periodEl.textContent = `${year}年${month}月`;
                    this.renderMonthView();
                } else if (this.currentView === 'list') {
                    const year = this.currentDate.getFullYear();
                    const month = this.currentDate.getMonth() + 1;
                    periodEl.textContent = `${year}年${month}月`;
                    this.renderListView();
                }
            },

            // 渲染週檢視
            renderWeekView() {
                const weekStart = this.getWeekStart(this.currentDate);
                const weekDays = [];
                const today = new Date().toDateString();
                
                for (let i = 0; i < 7; i++) {
                    const date = new Date(weekStart);
                    date.setDate(weekStart.getDate() + i);
                    weekDays.push(date);
                }

                let html = '<div class="week-view"><div class="week-grid">';
                
                // 標題列
                html += '<div class="week-header employee-col">員工</div>';
                const weekdayNames = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
                weekDays.forEach(day => {
                    const isToday = day.toDateString() === today;
                    html += `<div class="week-header ${isToday ? 'today' : ''}">
                        ${weekdayNames[day.getDay()]}<br>
                        ${day.getMonth() + 1}/${day.getDate()}
                    </div>`;
                });

                // 員工排班
                const filteredEmployees = this.getFilteredEmployees();
                
                filteredEmployees.forEach(employee => {
                    html += '<div class="employee-row">';
                    html += `
                        <div class="employee-cell">
                            <div class="employee-avatar">${employee.avatarText || employee.name.charAt(0)}</div>
                            <div>
                                <div>${employee.name}</div>
                                <div style="font-size: 12px; color: var(--gray);">
                                    ${employee.type === 'fulltime' ? '正職' : '兼職'}
                                </div>
                            </div>
                        </div>
                    `;

                    weekDays.forEach(day => {
                        const dateStr = this.formatDateKey(day);
                        const daySchedules = this.schedules[dateStr] || [];
                        const empSchedule = daySchedules.find(s => s.employeeId === employee.id);
                        const isToday = day.toDateString() === today;

                        html += `<div class="shift-cell ${isToday ? 'today' : ''}">`;
                        
                        if (empSchedule) {
                            const shift = this.shifts.find(s => 
                                s.startTime === empSchedule.startTime && 
                                s.endTime === empSchedule.endTime
                            );
                            
                            html += `
                                <div class="shift-badge">${shift ? shift.name : '班次'}</div>
                                <div class="shift-time">${empSchedule.startTime} - ${empSchedule.endTime}</div>
                            `;
                            
                            if (empSchedule.notes) {
                                html += `<div style="font-size: 11px; color: var(--gray); margin-top: 5px;">${empSchedule.notes}</div>`;
                            }
                        } else {
                            html += '<div class="no-shift">休假</div>';
                        }
                        
                        html += '</div>';
                    });
                    
                    html += '</div>';
                });

                html += '</div></div>';
                document.getElementById('contentArea').innerHTML = html;
            },

            // 渲染月檢視
            renderMonthView() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const firstDay = new Date(year, month, 1);
                const lastDay = new Date(year, month + 1, 0);
                const startDate = new Date(firstDay);
                startDate.setDate(startDate.getDate() - firstDay.getDay());
                
                const today = new Date().toDateString();
                const weekdayNames = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];

                let html = '<div class="month-view"><div class="month-calendar">';
                
                // 標題列
                weekdayNames.forEach(day => {
                    html += `<div class="calendar-header">${day}</div>`;
                });

                // 日期格子
                const currentDate = new Date(startDate);
                for (let week = 0; week < 6; week++) {
                    for (let day = 0; day < 7; day++) {
                        const dateStr = this.formatDateKey(currentDate);
                        const daySchedules = this.schedules[dateStr] || [];
                        const isCurrentMonth = currentDate.getMonth() === month;
                        const isToday = currentDate.toDateString() === today;
                        
                        html += `<div class="calendar-day ${!isCurrentMonth ? 'other-month' : ''} ${isToday ? 'today' : ''}">`;
                        html += `<div class="day-number">${currentDate.getDate()}</div>`;
                        html += '<div class="day-schedules">';
                        
                        // 顯示當天排班人數
                        if (daySchedules.length > 0) {
                            const workingCount = daySchedules.length;
                            html += `<div class="schedule-item">${workingCount} 人上班</div>`;
                            
                            // 顯示前幾個員工名字
                            const maxShow = 3;
                            daySchedules.slice(0, maxShow).forEach(schedule => {
                                const employee = this.employees.find(e => e.id === schedule.employeeId);
                                if (employee) {
                                    html += `<div style="font-size: 11px; color: var(--gray);">${employee.name}</div>`;
                                }
                            });
                            
                            if (daySchedules.length > maxShow) {
                                html += `<div style="font-size: 11px; color: var(--gray);">...還有 ${daySchedules.length - maxShow} 人</div>`;
                            }
                        }
                        
                        html += '</div></div>';
                        currentDate.setDate(currentDate.getDate() + 1);
                    }
                }

                html += '</div></div>';
                document.getElementById('contentArea').innerHTML = html;
            },

            // 渲染清單檢視
            renderListView() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth();
                const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
                
                // 收集當月所有排班
                const monthSchedules = [];
                Object.keys(this.schedules).forEach(date => {
                    if (date.startsWith(monthKey)) {
                        this.schedules[date].forEach(schedule => {
                            const employee = this.employees.find(e => e.id === schedule.employeeId);
                            if (employee) {
                                monthSchedules.push({
                                    date,
                                    employee,
                                    schedule
                                });
                            }
                        });
                    }
                });

                // 排序
                monthSchedules.sort((a, b) => {
                    const dateCompare = a.date.localeCompare(b.date);
                    if (dateCompare !== 0) return dateCompare;
                    return a.schedule.startTime.localeCompare(b.schedule.startTime);
                });

                let html = '<div class="list-view">';
                html += '<table class="schedule-table">';
                html += `
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>星期</th>
                            <th>員工</th>
                            <th>類型</th>
                            <th>班次時間</th>
                            <th>工時</th>
                            <th>備註</th>
                        </tr>
                    </thead>
                    <tbody>
                `;

                const weekdayNames = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
                
                monthSchedules.forEach(item => {
                    const date = new Date(item.date + 'T00:00:00');
                    const hours = this.calculateWorkHours(item.schedule.startTime, item.schedule.endTime);
                    
                    html += `
                        <tr>
                            <td>${item.date}</td>
                            <td>${weekdayNames[date.getDay()]}</td>
                            <td>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <div class="employee-avatar" style="width: 30px; height: 30px; font-size: 12px;">
                                        ${item.employee.avatarText || item.employee.name.charAt(0)}
                                    </div>
                                    ${item.employee.name}
                                </div>
                            </td>
                            <td>${item.employee.type === 'fulltime' ? '正職' : '兼職'}</td>
                            <td>${item.schedule.startTime} - ${item.schedule.endTime}</td>
                            <td>${hours} 小時</td>
                            <td>${item.schedule.notes || '-'}</td>
                        </tr>
                    `;
                });

                html += '</tbody></table></div>';
                document.getElementById('contentArea').innerHTML = html;
            },

            // 更新統計
            updateStatistics() {
                // 總員工數
                document.getElementById('totalEmployees').textContent = this.employees.length;

                // 今日上班人數
                const today = this.formatDateKey(new Date());
                const todaySchedules = this.schedules[today] || [];
                document.getElementById('todayWorking').textContent = todaySchedules.length;

                // 本月總工時和平均工時
                const year = new Date().getFullYear();
                const month = new Date().getMonth();
                const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
                
                let totalMinutes = 0;
                let daysWithSchedule = new Set();
                
                Object.keys(this.schedules).forEach(date => {
                    if (date.startsWith(monthKey)) {
                        const daySchedules = this.schedules[date];
                        if (daySchedules.length > 0) {
                            daysWithSchedule.add(date);
                        }
                        
                        daySchedules.forEach(schedule => {
                            const minutes = this.calculateWorkMinutes(schedule.startTime, schedule.endTime);
                            totalMinutes += minutes;
                        });
                    }
                });

                const totalHours = Math.floor(totalMinutes / 60);
                document.getElementById('totalHours').textContent = totalHours;

                const avgHours = daysWithSchedule.size > 0 
                    ? Math.round(totalHours / daysWithSchedule.size) 
                    : 0;
                document.getElementById('avgHours').textContent = avgHours;
            },

            // 設定檢視模式
            setViewMode(mode) {
                this.currentView = mode;
                
                // 更新按鈕狀態
                document.querySelectorAll('.view-mode-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.closest('.view-mode-btn').classList.add('active');
                
                this.updateDisplay();
            },

            // 設定頁籤
            setTab(tab) {
                this.currentTab = tab;
                
                // 更新頁籤狀態
                document.querySelectorAll('.tab').forEach(t => {
                    t.classList.remove('active');
                });
                event.target.classList.add('active');
                
                // 根據頁籤渲染不同內容
                if (tab === 'overview') {
                    this.updateDisplay();
                } else if (tab === 'statistics') {
                    this.renderStatistics();
                } else if (tab === 'comparison') {
                    this.renderComparison();
                }
            },

            // 渲染統計分析
            renderStatistics() {
                let html = '<div style="padding: 20px; text-align: center; color: var(--gray);">';
                html += '<span class="material-icons" style="font-size: 48px;">insert_chart</span>';
                html += '<p>統計分析功能開發中...</p>';
                html += '</div>';
                
                document.getElementById('contentArea').innerHTML = html;
            },

            // 渲染員工比較
            renderComparison() {
                let html = '<div style="padding: 20px; text-align: center; color: var(--gray);">';
                html += '<span class="material-icons" style="font-size: 48px;">compare</span>';
                html += '<p>員工比較功能開發中...</p>';
                html += '</div>';
                
                document.getElementById('contentArea').innerHTML = html;
            },

            // 上一個週期
            previousPeriod() {
                if (this.currentView === 'week') {
                    this.currentDate.setDate(this.currentDate.getDate() - 7);
                } else {
                    this.currentDate.setMonth(this.currentDate.getMonth() - 1);
                }
                this.updateDisplay();
            },

            // 下一個週期
            nextPeriod() {
                if (this.currentView === 'week') {
                    this.currentDate.setDate(this.currentDate.getDate() + 7);
                } else {
                    this.currentDate.setMonth(this.currentDate.getMonth() + 1);
                }
                this.updateDisplay();
            },

            // 回到今天
            goToToday() {
                this.currentDate = new Date();
                this.updateDisplay();
            },

            // 應用篩選
            applyFilters() {
                this.filters.type = document.getElementById('typeFilter').value;
                this.filters.shift = document.getElementById('shiftFilter').value;
                this.updateDisplay();
            },

            // 取得篩選後的員工
            getFilteredEmployees() {
                let filtered = [...this.employees];
                
                if (this.filters.type !== 'all') {
                    filtered = filtered.filter(e => e.type === this.filters.type);
                }
                
                return filtered;
            },

            // 更新班次篩選器
            updateShiftFilter() {
                const select = document.getElementById('shiftFilter');
                select.innerHTML = '<option value="all">全部班次</option>';
                
                this.shifts.forEach(shift => {
                    select.innerHTML += `<option value="${shift.id}">${shift.name}</option>`;
                });
            },

            // 匯出 Excel
            exportExcel() {
                const year = this.currentDate.getFullYear();
                const month = this.currentDate.getMonth() + 1;
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                
                let csv = '\ufeff'; // BOM for UTF-8
                csv += `Bleu Cafe 班表總覽 - ${year}年${month}月\n\n`;
                csv += '日期,星期,員工姓名,員工類型,班次時間,工時,備註\n';
                
                const weekdayNames = ['週日', '週一', '週二', '週三', '週四', '週五', '週六'];
                
                Object.keys(this.schedules).sort().forEach(date => {
                    if (date.startsWith(monthKey)) {
                        const dateObj = new Date(date + 'T00:00:00');
                        const weekday = weekdayNames[dateObj.getDay()];
                        
                        this.schedules[date].forEach(schedule => {
                            const employee = this.employees.find(e => e.id === schedule.employeeId);
                            if (employee) {
                                const hours = this.calculateWorkHours(schedule.startTime, schedule.endTime);
                                const type = employee.type === 'fulltime' ? '正職' : '兼職';
                                csv += `${date},${weekday},${employee.name},${type},`;
                                csv += `${schedule.startTime}-${schedule.endTime},${hours},${schedule.notes || ''}\n`;
                            }
                        });
                    }
                });
                
                // 下載檔案
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `Bleu班表總覽_${year}年${month}月.csv`;
                a.click();
                URL.revokeObjectURL(url);
            },

            // 列印
            print() {
                window.print();
            },

            // 工具函數
            formatDateKey(date) {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            },

            formatDate(date) {
                const month = date.getMonth() + 1;
                const day = date.getDate();
                return `${month}月${day}日`;
            },

            getWeekStart(date) {
                const d = new Date(date);
                const day = d.getDay();
                const diff = d.getDate() - day;
                return new Date(d.setDate(diff));
            },

            calculateWorkMinutes(startTime, endTime) {
                const [startHour, startMin] = startTime.split(':').map(Number);
                const [endHour, endMin] = endTime.split(':').map(Number);
                
                let startMinutes = startHour * 60 + startMin;
                let endMinutes = endHour * 60 + endMin;
                
                // 處理跨日情況
                if (endMinutes < startMinutes) {
                    endMinutes += 24 * 60;
                }
                
                return endMinutes - startMinutes;
            },

            calculateWorkHours(startTime, endTime) {
                const minutes = this.calculateWorkMinutes(startTime, endTime);
                return (minutes / 60).toFixed(1);
            }
        };

        // 初始化應用
        document.addEventListener('DOMContentLoaded', () => {
            App.init();
        });
    </script>
</body>
</html>
