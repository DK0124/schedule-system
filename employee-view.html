<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Bleu 班表系統 - 員工檢視">
    <meta name="author" content="DK0124">
    <title>Bleu 班表系統 - 員工檢視</title>
    
    <!-- Google Material Icons -->
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><path fill='%23003D52' d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/></svg>">
    
    <style>
        /* Bleu 班表系統 色系 */
        :root {
            --bleu-primary: #003D52;
            --bleu-secondary: #83968B;
            --bleu-accent: #EE7836;
            --bleu-light: #BCDBE4;
            --bleu-white: #FFFFFF;
            --bleu-bg: #F8FAFC;
            --bleu-gray-light: #EFF6F9;
            --bleu-gray: #DDE4E7;
            --bleu-gray-dark: #6B7C74;
            --bleu-text: #2C3E50;
            --bleu-shadow: 0 4px 15px rgba(0, 61, 82, 0.07);
            --bleu-shadow-hover: 0 6px 25px rgba(0, 61, 82, 0.1);
            --bleu-radius: 12px;
            --bleu-transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box; 
        }
        
        html { 
            scroll-behavior: smooth; 
        }
        
        body {
            font-family: 'Segoe UI', 'Microsoft JhengHei', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bleu-bg);
            color: var(--bleu-text);
            line-height: 1.6;
            overscroll-behavior: none;
        }

        .material-icons, 
        .material-icons-outlined { 
            vertical-align: middle; 
            font-size: 20px; 
        }
        
        .btn .material-icons, 
        .btn .material-icons-outlined { 
            margin-right: 6px; 
        }

        .app { 
            padding: 25px; 
        }

        /* 同步狀態指示器 */
        .sync-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bleu-white);
            border-radius: 20px;
            box-shadow: var(--bleu-shadow);
            z-index: 999;
            transition: var(--bleu-transition);
        }

        .sync-indicator.syncing {
            background: #FFF9C4;
        }

        .sync-indicator.success {
            background: #E8F5E9;
        }

        .sync-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
            100% { opacity: 1; transform: scale(1); }
        }

        .sync-text {
            font-size: 12px;
            color: var(--bleu-gray-dark);
            font-weight: 500;
        }

        .page-title { 
            display: flex; 
            align-items: center; 
            gap: 15px; 
            margin-bottom: 25px; 
        }
        
        .page-title h1 { 
            font-size: 28px; 
            font-weight: 700; 
            color: var(--bleu-primary); 
        }
        
        .page-title .material-icons { 
            font-size: 32px; 
            color: var(--bleu-primary); 
        }

        .btn {
            padding: 8px 18px; 
            border: none; 
            border-radius: 8px; 
            font-size: 14px;
            font-weight: 600; 
            cursor: pointer; 
            transition: var(--bleu-transition);
            display: inline-flex; 
            align-items: center; 
            gap: 8px; 
            white-space: nowrap;
        }
        
        .btn:disabled { 
            opacity: 0.5; 
            cursor: not-allowed; 
        }
        
        .btn-primary { 
            background: var(--bleu-primary); 
            color: white; 
        }
        
        .btn-primary:hover:not(:disabled) { 
            background: #002A3A; 
            transform: translateY(-2px); 
            box-shadow: var(--bleu-shadow-hover); 
        }
        
        .btn-secondary {
            background: var(--bleu-secondary);
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: #6B7C74;
        }
        
        .btn-accent { 
            background: var(--bleu-accent); 
            color: white; 
        }
        
        .btn-accent:hover:not(:disabled) { 
            background: #D66327; 
        }
        
        .btn-info {
            background: #17A2B8;
            color: white;
        }
        
        .btn-info:hover:not(:disabled) {
            background: #138496;
        }

        /* 主容器 */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* 員工選擇器 */
        .employee-selector {
            background: var(--bleu-white);
            border-radius: var(--bleu-radius);
            padding: 20px;
            box-shadow: var(--bleu-shadow);
            margin-bottom: 25px;
        }

        .selector-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .selector-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 600;
            color: var(--bleu-primary);
        }

        .employee-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 12px;
        }

        .employee-card {
            background: var(--bleu-gray-light);
            border: 2px solid transparent;
            border-radius: 8px;
            padding: 12px;
            cursor: pointer;
            transition: var(--bleu-transition);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .employee-card:hover {
            background: var(--bleu-light);
            transform: translateY(-2px);
            box-shadow: var(--bleu-shadow);
        }

        .employee-card.selected {
            background: var(--bleu-primary);
            color: white;
            border-color: var(--bleu-primary);
        }

        .employee-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--bleu-accent);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 16px;
            flex-shrink: 0;
        }

        .employee-card.selected .employee-avatar {
            background: white;
            color: var(--bleu-primary);
        }

        .employee-info {
            flex: 1;
            min-width: 0;
        }

        .employee-name {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .employee-type {
            font-size: 11px;
            opacity: 0.8;
        }

        /* 統計卡片 */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: var(--bleu-white);
            border-radius: var(--bleu-radius);
            padding: 20px;
            box-shadow: var(--bleu-shadow);
            transition: var(--bleu-transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--bleu-shadow-hover);
        }

        .stat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .stat-icon.primary {
            background: var(--bleu-light);
            color: var(--bleu-primary);
        }

        .stat-icon.accent {
            background: rgba(238, 120, 54, 0.1);
            color: var(--bleu-accent);
        }

        .stat-icon.success {
            background: rgba(40, 167, 69, 0.1);
            color: #28A745;
        }

        .stat-title {
            font-size: 13px;
            color: var(--bleu-gray-dark);
            font-weight: 500;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--bleu-primary);
        }

        .stat-subtitle {
            font-size: 12px;
            color: var(--bleu-gray-dark);
            margin-top: 8px;
        }

        /* 月曆容器 */
        .calendar-container {
            background: var(--bleu-white);
            border-radius: var(--bleu-radius);
            padding: 25px;
            box-shadow: var(--bleu-shadow);
            margin-bottom: 25px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--bleu-gray-light);
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .calendar-title {
            font-size: 22px;
            font-weight: 600;
            color: var(--bleu-primary);
        }

        .calendar-actions {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-icon {
            padding: 8px;
            border-radius: 50%;
            background: transparent;
            color: var(--bleu-primary);
            border: none;
            cursor: pointer;
            transition: var(--bleu-transition);
        }

        .btn-icon:hover {
            background: var(--bleu-light);
        }

        /* 月曆格子 */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-top: 1px solid var(--bleu-gray);
            border-left: 1px solid var(--bleu-gray);
        }

        .calendar-cell {
            border-right: 1px solid var(--bleu-gray);
            border-bottom: 1px solid var(--bleu-gray);
            min-height: 100px;
            padding: 8px;
            display: flex;
            flex-direction: column;
        }

        .weekday-header {
            text-align: center;
            font-weight: 600;
            font-size: 13px;
            color: var(--bleu-secondary);
            padding: 10px 0;
        }

        .date-cell {
            position: relative;
        }

        .date-number {
            font-weight: 600;
            color: var(--bleu-text);
            margin-bottom: 8px;
            text-align: right;
        }

        .date-cell.today .date-number {
            background: var(--bleu-primary);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: auto;
        }

        .date-cell.other-month {
            opacity: 0.4;
            background-color: #F8F9FA;
        }

        .schedule-info {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
        }

        .shift-badge {
            background: var(--bleu-light);
            color: var(--bleu-primary);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 600;
            text-align: center;
            transition: var(--bleu-transition);
        }

        .shift-badge:hover {
            background: var(--bleu-primary);
            color: white;
            transform: scale(1.05);
        }

        /* 總表容器 - 新增 */
        .overall-schedule-container {
            background: var(--bleu-white);
            border-radius: var(--bleu-radius);
            padding: 20px;
            box-shadow: var(--bleu-shadow);
            margin-bottom: 25px;
        }

        .overall-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--bleu-gray-light);
        }

        .overall-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--bleu-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .daily-schedule-grid {
            display: grid;
            gap: 15px;
        }

        .daily-schedule-card {
            background: var(--bleu-gray-light);
            border-radius: 8px;
            padding: 15px;
            transition: var(--bleu-transition);
        }

        .daily-schedule-card:hover {
            background: var(--bleu-light);
            transform: translateX(5px);
        }

        .daily-date {
            font-weight: 600;
            color: var(--bleu-primary);
            margin-bottom: 10px;
            font-size: 16px;
        }

        .daily-employees {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .colleague-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            background: var(--bleu-white);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 13px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .colleague-avatar {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
        }

        .colleague-time {
            font-size: 11px;
            color: var(--bleu-gray-dark);
        }

        /* 班次列表 */
        .schedule-list-container {
            background: var(--bleu-white);
            border-radius: var(--bleu-radius);
            padding: 20px;
            box-shadow: var(--bleu-shadow);
        }

        .list-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--bleu-gray-light);
        }

        .list-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--bleu-primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .schedule-item {
            display: flex;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            background: var(--bleu-gray-light);
            border-radius: 8px;
            transition: var(--bleu-transition);
        }

        .schedule-item:hover {
            background: var(--bleu-light);
            transform: translateX(5px);
        }

        .schedule-date {
            min-width: 100px;
            font-weight: 600;
            color: var(--bleu-primary);
        }

        .schedule-time {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--bleu-text);
        }

        .schedule-time .material-icons {
            font-size: 16px;
            color: var(--bleu-secondary);
        }

        .schedule-note {
            font-size: 12px;
            color: var(--bleu-gray-dark);
            font-style: italic;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--bleu-gray-dark);
        }

        .empty-state .material-icons {
            font-size: 48px;
            color: var(--bleu-gray);
            margin-bottom: 10px;
        }

        /* Toast 通知 */
        .toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--bleu-primary);
            color: white;
            padding: 14px 24px;
            border-radius: 8px;
            opacity: 0;
            transition: var(--bleu-transition);
            z-index: 2000;
            box-shadow: 0 4px 20px rgba(0, 61, 82, 0.3);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            background: #28A745;
        }

        .toast.error {
            background: #DC3545;
        }

        /* RWD 響應式設計 */
        @media (max-width: 768px) {
            .app {
                padding: 10px;
            }

            .page-title h1 {
                font-size: 20px;
            }

            .sync-indicator {
                top: 10px;
                right: 10px;
                padding: 6px 12px;
            }

            .employee-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .employee-card {
                padding: 8px;
            }

            .calendar-container {
                padding: 10px;
            }

            .calendar-header {
                flex-direction: column;
                gap: 10px;
            }

            .calendar-cell {
                min-height: 70px;
                padding: 4px;
            }

            .date-number {
                font-size: 12px;
            }

            .shift-badge {
                font-size: 10px;
                padding: 2px 4px;
            }

            .stats-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }

            .btn {
                padding: 6px 10px;
                font-size: 12px;
            }

            .calendar-title {
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <!-- 同步狀態指示器 -->
    <div class="sync-indicator" id="syncIndicator">
        <div class="sync-dot"></div>
        <span class="sync-text">已連線</span>
    </div>

    <div class="app">
        <div class="main-container">
            <!-- 頁面標題 -->
            <div class="page-title">
                <span class="material-icons">badge</span>
                <h1>員工班表檢視</h1>
            </div>

            <!-- 員工選擇器 -->
            <div class="employee-selector">
                <div class="selector-header">
                    <div class="selector-title">
                        <span class="material-icons">person</span>
                        選擇員工
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-secondary" onclick="EmployeeView.refreshData()">
                            <span class="material-icons">refresh</span>
                            重新整理
                        </button>
                        <button class="btn btn-info" onclick="EmployeeView.toggleOverallView()">
                            <span class="material-icons">groups</span>
                            總表檢視
                        </button>
                    </div>
                </div>
                <div class="employee-grid" id="employeeGrid">
                    <!-- 員工卡片會動態載入 -->
                </div>
            </div>

            <!-- 統計資訊 -->
            <div class="stats-container" id="statsContainer">
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon primary">
                            <span class="material-icons">event</span>
                        </div>
                        <div>
                            <div class="stat-title">本月班次</div>
                            <div class="stat-value" id="monthShifts">0</div>
                        </div>
                    </div>
                    <div class="stat-subtitle">當月總排班次數</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon accent">
                            <span class="material-icons">schedule</span>
                        </div>
                        <div>
                            <div class="stat-title">總工時</div>
                            <div class="stat-value" id="totalHours">0</div>
                        </div>
                    </div>
                    <div class="stat-subtitle">小時</div>
                </div>
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-icon success">
                            <span class="material-icons">upcoming</span>
                        </div>
                        <div>
                            <div class="stat-title">下次上班</div>
                            <div class="stat-value" id="nextShift" style="font-size: 16px;">--</div>
                        </div>
                    </div>
                    <div class="stat-subtitle" id="nextShiftTime">尚無排班</div>
                </div>
            </div>

            <!-- 總表容器 - 顯示誰一起上班 -->
            <div class="overall-schedule-container" id="overallScheduleContainer" style="display: none;">
                <div class="overall-header">
                    <div class="overall-title">
                        <span class="material-icons">groups</span>
                        本月總表 - 同事排班一覽
                    </div>
                </div>
                <div class="daily-schedule-grid" id="overallScheduleGrid">
                    <!-- 動態生成的總表內容 -->
                </div>
            </div>

            <!-- 月曆 -->
            <div class="calendar-container" id="calendarContainer">
                <div class="calendar-header">
                    <div class="calendar-nav">
                        <button class="btn-icon" onclick="EmployeeView.previousMonth()">
                            <span class="material-icons">chevron_left</span>
                        </button>
                        <h2 class="calendar-title" id="currentMonth"></h2>
                        <button class="btn-icon" onclick="EmployeeView.nextMonth()">
                            <span class="material-icons">chevron_right</span>
                        </button>
                    </div>
                    <div class="calendar-actions">
                        <button class="btn btn-accent" onclick="EmployeeView.exportPersonalSchedule()">
                            <span class="material-icons">download</span>
                            匯出行程
                        </button>
                    </div>
                </div>
                <div id="calendarHeader" class="calendar-grid"></div>
                <div class="calendar-grid" id="calendarGrid"></div>
            </div>

            <!-- 班次列表 -->
            <div class="schedule-list-container" id="scheduleListContainer">
                <div class="list-header">
                    <div class="list-title">
                        <span class="material-icons">list</span>
                        本月班次明細
                    </div>
                </div>
                <div id="scheduleList">
                    <div class="empty-state">
                        <span class="material-icons">event_busy</span>
                        <p>請選擇員工以查看班表</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast 通知 -->
    <div class="toast" id="toast"></div>

    <script>
        const EmployeeView = {
            scriptUrl: 'https://script.google.com/macros/s/AKfycbzDImzTB17fp5FViVwXtIzxUrH-ByJ4p2lRrk__YPG-DJctKsE2YRZ3CqXlrHkZeZbW3A/exec',
            
            employees: [],
            schedules: {},
            shifts: [],
            selectedEmployee: null,
            currentMonth: new Date(),
            showOverallView: false,
            
            async init() {
                await this.loadData();
                this.renderEmployees();
                this.renderCalendar();
                this.updateStats();
                
                // 自動刷新
                setInterval(() => this.loadData(true), 30000);
            },
            
            async loadData(silent = false) {
                if (!silent) this.showToast('載入中...', 'info');
                
                try {
                    const response = await fetch(`${this.scriptUrl}?action=getRealtimeData`);
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        this.employees = result.data.employees || [];
                        this.shifts = result.data.shifts || [];
                        
                        // 處理排班資料
                        if (Array.isArray(result.data.schedules)) {
                            this.schedules = {};
                            result.data.schedules.forEach(schedule => {
                                const date = schedule.date;
                                if (!this.schedules[date]) {
                                    this.schedules[date] = [];
                                }
                                this.schedules[date].push({
                                    employeeId: schedule.employeeId,
                                    startTime: schedule.startTime,
                                    endTime: schedule.endTime,
                                    notes: schedule.notes || ''
                                });
                            });
                        } else {
                            this.schedules = result.data.schedules || {};
                        }
                        
                        if (!silent) {
                            this.showToast('資料已更新', 'success');
                            this.updateSyncStatus(true);
                        }
                        
                        // 如果有選中的員工，更新顯示
                        if (this.selectedEmployee) {
                            this.renderCalendar();
                            this.renderScheduleList();
                            this.updateStats();
                        }
                        
                        // 更新總表
                        if (this.showOverallView) {
                            this.renderOverallSchedule();
                        }
                    }
                } catch (error) {
                    console.error('載入失敗:', error);
                    if (!silent) {
                        this.showToast('載入失敗', 'error');
                        this.updateSyncStatus(false);
                    }
                    // 載入本地資料
                    this.loadLocalData();
                }
            },
            
            loadLocalData() {
                const data = localStorage.getItem('bleuScheduleData');
                if (data) {
                    const parsed = JSON.parse(data);
                    this.employees = parsed.employees || [];
                    this.schedules = parsed.schedules || {};
                    this.shifts = parsed.shifts || [];
                }
            },
            
            // 改進的顏色生成函數
            generateDistinctColor(id, name) {
                const distinctColors = [
                    "#E91E63", "#9C27B0", "#673AB7", "#3F51B5", "#2196F3",
                    "#03A9F4", "#00BCD4", "#009688", "#4CAF50", "#8BC34A",
                    "#CDDC39", "#FFC107", "#FF9800", "#FF5722", "#795548",
                    "#607D8B", "#F44336", "#00ACC1", "#7B1FA2", "#303F9F",
                    "#0288D1", "#0097A7", "#00796B", "#388E3C", "#689F38",
                    "#AFB42B", "#FFA000", "#F57C00", "#E64A19", "#5D4037",
                    "#455A64", "#C2185B", "#7C4DFF", "#536DFE", "#448AFF",
                    "#40C4FF", "#18FFFF", "#64FFDA", "#69F0AE", "#B2FF59",
                    "#EEFF41", "#FFD740", "#FFAB40", "#FF6E40"
                ];
                
                const hash = (id + (name || '')).split('').reduce((acc, char) => {
                    return char.charCodeAt(0) + ((acc << 5) - acc);
                }, 0);
                
                return distinctColors[Math.abs(hash) % distinctColors.length];
            },
            
            renderEmployees() {
                const grid = document.getElementById('employeeGrid');
                grid.innerHTML = '';
                
                if (this.employees.length === 0) {
                    grid.innerHTML = '<div style="grid-column: 1/-1; text-align: center; padding: 20px; color: var(--bleu-gray-dark);">尚無員工資料</div>';
                    return;
                }
                
                this.employees.forEach(emp => {
                    const card = document.createElement('div');
                    card.className = 'employee-card';
                    if (this.selectedEmployee && this.selectedEmployee.id === emp.id) {
                        card.classList.add('selected');
                    }
                    
                    const avatarColor = this.generateDistinctColor(emp.id, emp.name);
                    
                    card.innerHTML = `
                        <div class="employee-avatar" style="background: ${avatarColor}">
                            ${emp.avatarText || emp.name.charAt(0)}
                        </div>
                        <div class="employee-info">
                            <div class="employee-name">${emp.name}</div>
                            <div class="employee-type">${emp.type === 'fulltime' ? '正職' : '兼職'}</div>
                        </div>
                    `;
                    
                    card.onclick = () => this.selectEmployee(emp);
                    grid.appendChild(card);
                });
            },
            
            selectEmployee(employee) {
                this.selectedEmployee = employee;
                this.renderEmployees();
                this.renderCalendar();
                this.renderScheduleList();
                this.updateStats();
                this.showToast(`已選擇 ${employee.name} 的班表`, 'success');
            },
            
            toggleOverallView() {
                this.showOverallView = !this.showOverallView;
                
                const overallContainer = document.getElementById('overallScheduleContainer');
                const calendarContainer = document.getElementById('calendarContainer');
                const scheduleListContainer = document.getElementById('scheduleListContainer');
                
                if (this.showOverallView) {
                    overallContainer.style.display = 'block';
                    calendarContainer.style.display = 'none';
                    scheduleListContainer.style.display = 'none';
                    this.renderOverallSchedule();
                } else {
                    overallContainer.style.display = 'none';
                    calendarContainer.style.display = 'block';
                    scheduleListContainer.style.display = 'block';
                }
            },
            
            renderOverallSchedule() {
                const grid = document.getElementById('overallScheduleGrid');
                grid.innerHTML = '';
                
                const year = this.currentMonth.getFullYear();
                const month = this.currentMonth.getMonth();
                const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
                
                // 收集本月所有有排班的日期
                const monthDates = Object.keys(this.schedules)
                    .filter(date => date.startsWith(monthKey))
                    .sort();
                
                if (monthDates.length === 0) {
                    grid.innerHTML = '<div class="empty-state">本月尚無排班</div>';
                    return;
                }
                
                // 為每個日期建立卡片
                monthDates.forEach(date => {
                    const daySchedules = this.schedules[date] || [];
                    if (daySchedules.length === 0) return;
                    
                    const card = document.createElement('div');
                    card.className = 'daily-schedule-card';
                    
                    const dateObj = new Date(date + 'T00:00:00');
                    const weekday = ['日', '一', '二', '三', '四', '五', '六'][dateObj.getDay()];
                    
                    // 按時間排序
                    const sortedSchedules = [...daySchedules].sort((a, b) => {
                        return this.timeToMinutes(a.startTime) - this.timeToMinutes(b.startTime);
                    });
                    
                    // 建立員工時段表
                    const employeeHTML = sortedSchedules.map(schedule => {
                        const emp = this.employees.find(e => e.id == schedule.employeeId);
                        if (!emp) return '';
                        
                        const avatarColor = this.generateDistinctColor(emp.id, emp.name);
                        const isSelected = this.selectedEmployee && this.selectedEmployee.id == emp.id;
                        
                        return `
                            <div class="colleague-badge" ${isSelected ? 'style="background: var(--bleu-primary); color: white;"' : ''}>
                                <div class="colleague-avatar" style="background: ${avatarColor}">
                                    ${emp.avatarText || emp.name.charAt(0)}
                                </div>
                                <div>
                                    <div style="font-weight: 600;">${emp.name}</div>
                                    <div class="colleague-time">${schedule.startTime} - ${schedule.endTime}</div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    card.innerHTML = `
                        <div class="daily-date">${month + 1}月${dateObj.getDate()}日 (週${weekday})</div>
                        <div class="daily-employees">
                            ${employeeHTML}
                        </div>
                    `;
                    
                    grid.appendChild(card);
                });
            },
            
            renderCalendar() {
                const year = this.currentMonth.getFullYear();
                const month = this.currentMonth.getMonth();
                document.getElementById('currentMonth').textContent = `${year}年 ${month + 1}月`;
                
                const calendarGrid = document.getElementById('calendarGrid');
                const calendarHeader = document.getElementById('calendarHeader');
                calendarGrid.innerHTML = '';
                calendarHeader.innerHTML = '';
                
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                calendarHeader.className = 'calendar-grid';
                
                weekdays.forEach(day => {
                    const headerCell = document.createElement('div');
                    headerCell.className = 'weekday-header';
                    headerCell.textContent = day;
                    calendarHeader.appendChild(headerCell);
                });
                
                const firstDay = new Date(year, month, 1).getDay();
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                
                for (let i = 0; i < firstDay; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'calendar-cell other-month';
                    calendarGrid.appendChild(cell);
                }
                
                for (let date = 1; date <= daysInMonth; date++) {
                    const cell = this.createDateCell(year, month, date);
                    calendarGrid.appendChild(cell);
                }
            },
            
            createDateCell(year, month, date) {
                const cell = document.createElement('div');
                cell.className = 'calendar-cell date-cell';
                const dateKey = `${year}-${String(month + 1).padStart(2, '0')}-${String(date).padStart(2, '0')}`;
                const today = new Date();
                
                if (year === today.getFullYear() && month === today.getMonth() && date === today.getDate()) {
                    cell.classList.add('today');
                }
                
                const numberDiv = document.createElement('div');
                numberDiv.className = 'date-number';
                numberDiv.textContent = date;
                
                const scheduleDiv = document.createElement('div');
                scheduleDiv.className = 'schedule-info';
                
                if (this.selectedEmployee && this.schedules[dateKey]) {
                    const daySchedules = this.schedules[dateKey].filter(s => 
                        s.employeeId == this.selectedEmployee.id
                    );
                    
                    if (daySchedules.length > 0) {
                        daySchedules.forEach(schedule => {
                            const badge = document.createElement('div');
                            badge.className = 'shift-badge';
                            badge.textContent = `${schedule.startTime}-${schedule.endTime}`;
                            badge.title = schedule.notes || '無備註';
                            scheduleDiv.appendChild(badge);
                        });
                    }
                }
                
                cell.appendChild(numberDiv);
                cell.appendChild(scheduleDiv);
                return cell;
            },
            
            renderScheduleList() {
                const listContainer = document.getElementById('scheduleList');
                
                if (!this.selectedEmployee) {
                    listContainer.innerHTML = `
                        <div class="empty-state">
                            <span class="material-icons">event_busy</span>
                            <p>請選擇員工以查看班表</p>
                        </div>
                    `;
                    return;
                }
                
                const year = this.currentMonth.getFullYear();
                const month = this.currentMonth.getMonth();
                const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
                
                const monthSchedules = [];
                Object.keys(this.schedules).forEach(date => {
                    if (date.startsWith(monthKey)) {
                        const daySchedules = this.schedules[date].filter(s => 
                            s.employeeId == this.selectedEmployee.id
                        );
                        daySchedules.forEach(schedule => {
                            monthSchedules.push({
                                date: date,
                                ...schedule
                            });
                        });
                    }
                });
                
                if (monthSchedules.length === 0) {
                    listContainer.innerHTML = `
                        <div class="empty-state">
                            <span class="material-icons">event_available</span>
                            <p>本月尚無排班</p>
                        </div>
                    `;
                    return;
                }
                
                monthSchedules.sort((a, b) => a.date.localeCompare(b.date));
                
                listContainer.innerHTML = '';
                monthSchedules.forEach(schedule => {
                    const item = document.createElement('div');
                    item.className = 'schedule-item';
                    
                    const dateObj = new Date(schedule.date + 'T00:00:00');
                    const weekday = ['日', '一', '二', '三', '四', '五', '六'][dateObj.getDay()];
                    
                    // 找出同一天的其他員工
                    const colleagues = this.schedules[schedule.date]
                        .filter(s => s.employeeId != this.selectedEmployee.id)
                        .map(s => {
                            const emp = this.employees.find(e => e.id == s.employeeId);
                            return emp ? emp.name : '';
                        })
                        .filter(name => name);
                    
                    const colleagueText = colleagues.length > 0 
                        ? `<div style="font-size: 11px; color: var(--bleu-secondary); margin-top: 4px;">
                            共同值班: ${colleagues.join(', ')}
                           </div>`
                        : '';
                    
                    item.innerHTML = `
                        <div class="schedule-date">${schedule.date.slice(5)} (${weekday})</div>
                        <div class="schedule-time">
                            <span class="material-icons">schedule</span>
                            ${schedule.startTime} - ${schedule.endTime}
                            ${schedule.notes ? `<span class="schedule-note">${schedule.notes}</span>` : ''}
                            ${colleagueText}
                        </div>
                    `;
                    listContainer.appendChild(item);
                });
            },
            
            updateStats() {
                if (!this.selectedEmployee) {
                    document.getElementById('monthShifts').textContent = '0';
                    document.getElementById('totalHours').textContent = '0';
                    document.getElementById('nextShift').textContent = '--';
                    document.getElementById('nextShiftTime').textContent = '尚無排班';
                    return;
                }
                
                const year = this.currentMonth.getFullYear();
                const month = this.currentMonth.getMonth();
                const monthKey = `${year}-${String(month + 1).padStart(2, '0')}`;
                const today = new Date().toISOString().slice(0, 10);
                
                let monthShifts = 0;
                let totalMinutes = 0;
                let nextShift = null;
                
                Object.keys(this.schedules).forEach(date => {
                    if (date.startsWith(monthKey)) {
                        const daySchedules = this.schedules[date].filter(s => 
                            s.employeeId == this.selectedEmployee.id
                        );
                        monthShifts += daySchedules.length;
                        
                        daySchedules.forEach(schedule => {
                            const minutes = this.calculateMinutes(schedule.startTime, schedule.endTime);
                            totalMinutes += minutes;
                        });
                    }
                    
                    if (date >= today && !nextShift) {
                        const daySchedules = this.schedules[date].filter(s => 
                            s.employeeId == this.selectedEmployee.id
                        );
                        if (daySchedules.length > 0) {
                            nextShift = {
                                date: date,
                                ...daySchedules[0]
                            };
                        }
                    }
                });
                
                document.getElementById('monthShifts').textContent = monthShifts;
                document.getElementById('totalHours').textContent = Math.floor(totalMinutes / 60);
                
                if (nextShift) {
                    const dateObj = new Date(nextShift.date + 'T00:00:00');
                    const weekday = ['日', '一', '二', '三', '四', '五', '六'][dateObj.getDay()];
                    document.getElementById('nextShift').textContent = `${nextShift.date.slice(5)} (${weekday})`;
                    document.getElementById('nextShiftTime').textContent = `${nextShift.startTime} - ${nextShift.endTime}`;
                } else {
                    document.getElementById('nextShift').textContent = '--';
                    document.getElementById('nextShiftTime').textContent = '尚無排班';
                }
            },
            
            calculateMinutes(startTime, endTime) {
                const [startH, startM] = startTime.split(':').map(Number);
                const [endH, endM] = endTime.split(':').map(Number);
                let minutes = (endH * 60 + endM) - (startH * 60 + startM);
                if (minutes < 0) minutes += 24 * 60;
                return minutes;
            },
            
            timeToMinutes(time) {
                const [hours, minutes] = time.split(':').map(Number);
                return hours * 60 + minutes;
            },
            
            previousMonth() {
                this.currentMonth.setMonth(this.currentMonth.getMonth() - 1);
                this.renderCalendar();
                this.renderScheduleList();
                this.updateStats();
                if (this.showOverallView) {
                    this.renderOverallSchedule();
                }
            },
            
            nextMonth() {
                this.currentMonth.setMonth(this.currentMonth.getMonth() + 1);
                this.renderCalendar();
                this.renderScheduleList();
                this.updateStats();
                if (this.showOverallView) {
                    this.renderOverallSchedule();
                }
            },
            
            async refreshData() {
                await this.loadData();
                this.renderEmployees();
                if (this.selectedEmployee) {
                    this.renderCalendar();
                    this.renderScheduleList();
                    this.updateStats();
                }
                if (this.showOverallView) {
                    this.renderOverallSchedule();
                }
            },
            
            exportPersonalSchedule() {
                if (!this.selectedEmployee) {
                    this.showToast('請先選擇員工', 'error');
                    return;
                }
                
                const year = this.currentMonth.getFullYear();
                const month = this.currentMonth.getMonth() + 1;
                
                let csv = '\ufeff';
                csv += `${this.selectedEmployee.name} - ${year}年${month}月班表\n\n`;
                csv += '日期,星期,上班時間,下班時間,備註\n';
                
                const monthKey = `${year}-${String(month).padStart(2, '0')}`;
                const weekdays = ['日', '一', '二', '三', '四', '五', '六'];
                
                Object.keys(this.schedules)
                    .filter(date => date.startsWith(monthKey))
                    .sort()
                    .forEach(date => {
                        const daySchedules = this.schedules[date].filter(s => 
                            s.employeeId == this.selectedEmployee.id
                        );
                        
                        daySchedules.forEach(schedule => {
                            const dateObj = new Date(date + 'T00:00:00');
                            const weekday = weekdays[dateObj.getDay()];
                            csv += `${date},${weekday},${schedule.startTime},${schedule.endTime},${schedule.notes || ''}\n`;
                        });
                    });
                
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${this.selectedEmployee.name}_${year}年${month}月班表.csv`;
                a.click();
                URL.revokeObjectURL(url);
                
                this.showToast('班表已匯出', 'success');
            },
            
            updateSyncStatus(connected) {
                const indicator = document.getElementById('syncIndicator');
                const text = indicator.querySelector('.sync-text');
                
                if (connected) {
                    indicator.classList.add('success');
                    text.textContent = '已連線';
                } else {
                    indicator.classList.remove('success');
                    text.textContent = '離線模式';
                }
            },
            
            showToast(message, type = 'info') {
                const toast = document.getElementById('toast');
                toast.textContent = message;
                toast.className = 'toast show';
                if (type === 'success') toast.classList.add('success');
                if (type === 'error') toast.classList.add('error');
                
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => {
            EmployeeView.init();
        });
    </script>
</body>
</html>
